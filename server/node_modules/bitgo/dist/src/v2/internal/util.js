"use strict";
/**
 * @prettier
 * @hidden
 */
Object.defineProperty(exports, "__esModule", { value: true });
/**
 */
var bitcoin = require("bitgo-utxo-lib");
var Big = require("big.js");
var _ = require("lodash");
var crypto = require("crypto");
var debugLib = require("debug");
var errors_1 = require("../../errors");
var debug = debugLib('bitgo:v2:util');
var ethUtil;
var isEthAvailable = false;
var ethImport = 'ethereumjs-util';
Promise.resolve().then(function () { return require('ethereumjs-util'); }).then(function (eth) {
    ethUtil = eth;
    isEthAvailable = true;
})
    .catch(function (e) {
    // ethereum currently not supported
    debug('unable to load ethereumjs-util:');
    debug(e.stack);
});
/**
 * Create a request tracer for tracing workflows which involve multiple round trips to the server
 */
var RequestTracer = /** @class */ (function () {
    function RequestTracer() {
        this._seq = 0;
        this._seed = crypto.randomBytes(10);
    }
    RequestTracer.prototype.inc = function () {
        this._seq++;
    };
    RequestTracer.prototype.toString = function () {
        return this._seed.toString('hex') + "-" + _.padStart(this._seq.toString(16), 4, '0');
    };
    return RequestTracer;
}());
exports.RequestTracer = RequestTracer;
var Util = /** @class */ (function () {
    function Util() {
    }
    /**
     * @deprecated
     */
    Util.isEthAvailable = function () {
        return isEthAvailable;
    };
    /**
     * Convert a big.js big number to an array of unsigned bytes
     * @param bn
     * @deprecated
     */
    Util.bnToByteArrayUnsigned = function (bn) {
        var ba = bn.abs().toByteArray();
        if (ba.length) {
            if (ba[0] === 0) {
                ba = ba.slice(1);
            }
            return ba.map(function (v) {
                return v < 0 ? v + 256 : v;
            });
        }
        else {
            // Empty array, nothing to do
            return ba;
        }
    };
    /**
     * Generate the output script for a BTC P2SH multisig address
     * @param m
     * @param pubKeys
     * @deprecated
     */
    Util.p2shMultisigOutputScript = function (m, pubKeys) {
        var redeemScript = bitcoin.script.multisig.output.encode(m, pubKeys);
        var hash = bitcoin.crypto.hash160(redeemScript);
        return bitcoin.script.scriptHash.output.encode(hash);
    };
    /**
     * Utility method for handling arguments of pageable queries
     * @param params
     * @deprecated
     */
    Util.preparePageableQuery = function (params) {
        if (params === void 0) { params = {}; }
        var query = {};
        if (params.limit) {
            if (!_.isNumber(params.limit)) {
                throw new Error('invalid limit argument, expecting number');
            }
            query.limit = params.limit;
        }
        if (params.skip) {
            if (!_.isNumber(params.skip)) {
                throw new Error('invalid skip argument, expecting number');
            }
            query.skip = params.skip;
        }
        return query;
    };
    /**
     * Create a request identifier for tracing multi-request workflows
     */
    Util.createRequestId = function () {
        return new RequestTracer();
    };
    /**
     * Convert a BTC xpub to an Ethereum address (with 0x) prefix
     * @param xpub
     * @deprecated
     */
    Util.xpubToEthAddress = function (xpub) {
        if (!isEthAvailable) {
            throw new errors_1.EthereumLibraryUnavailableError(ethImport);
        }
        var hdNode = bitcoin.HDNode.fromBase58(xpub);
        var ethPublicKey = hdNode.keyPair.__Q.getEncoded(false).slice(1);
        return ethUtil.bufferToHex(ethUtil.publicToAddress(ethPublicKey, false));
    };
    /**
     * Convert a BTC xpriv to an Ethereum private key (without 0x prefix)
     * @param xprv
     * @deprecated
     */
    Util.xprvToEthPrivateKey = function (xprv) {
        var hdNode = bitcoin.HDNode.fromBase58(xprv);
        var ethPrivateKey = hdNode.keyPair.d.toBuffer(32);
        return ethPrivateKey.toString('hex');
    };
    /**
     * Sign a message using Ethereum's ECsign method and return the signature string
     * @param msgHash
     * @param privKey
     * @deprecated
     */
    Util.ethSignMsgHash = function (msgHash, privKey) {
        if (!isEthAvailable) {
            throw new errors_1.EthereumLibraryUnavailableError(ethImport);
        }
        var signatureInParts = ethUtil.ecsign(new Buffer(ethUtil.stripHexPrefix(msgHash), 'hex'), new Buffer(privKey, 'hex'));
        // Assemble strings from r, s and v
        var r = ethUtil.setLengthLeft(signatureInParts.r, 32).toString('hex');
        var s = ethUtil.setLengthLeft(signatureInParts.s, 32).toString('hex');
        var v = ethUtil.stripHexPrefix(ethUtil.intToHex(signatureInParts.v));
        // Concatenate the r, s and v parts to make the signature string
        return ethUtil.addHexPrefix(r.concat(s, v));
    };
    /**
     * Convert from wei string (or BN) to Ether (multiply by 1e18)
     * @param wei
     * @deprecated
     */
    Util.weiToEtherString = function (wei) {
        if (!isEthAvailable) {
            throw new errors_1.EthereumLibraryUnavailableError(ethImport);
        }
        var bn = wei;
        if (!(wei instanceof ethUtil.BN)) {
            bn = new ethUtil.BN(wei);
        }
        Big.E_POS = 256;
        Big.E_NEG = -18;
        var weiString = bn.toString(10);
        var big = new Big(weiString);
        // 10^18
        var ether = big.div('1000000000000000000');
        return ether.toPrecision();
    };
    /**
     * Recover an ethereum address from a signature and message hash
     * @param msgHash
     * @param signature
     * @deprecated
     */
    Util.ecRecoverEthAddress = function (msgHash, signature) {
        msgHash = ethUtil.stripHexPrefix(msgHash);
        signature = ethUtil.stripHexPrefix(signature);
        var v = parseInt(signature.slice(128, 130), 16);
        var r = new Buffer(signature.slice(0, 64), 'hex');
        var s = new Buffer(signature.slice(64, 128), 'hex');
        var pubKey = ethUtil.ecrecover(new Buffer(msgHash, 'hex'), v, r, s);
        return ethUtil.bufferToHex(ethUtil.pubToAddress(pubKey));
    };
    return Util;
}());
exports.Util = Util;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy92Mi9pbnRlcm5hbC91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBRUg7R0FDRztBQUNILHdDQUEwQztBQUMxQyw0QkFBOEI7QUFDOUIsMEJBQTRCO0FBQzVCLCtCQUFpQztBQUNqQyxnQ0FBa0M7QUFDbEMsdUNBQStEO0FBRy9ELElBQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUV4QyxJQUFJLE9BQU8sQ0FBQztBQUNaLElBQUksY0FBYyxHQUFHLEtBQUssQ0FBQztBQUUzQixJQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQztBQUNwQyxvREFBTyxpQkFBaUIsTUFDckIsSUFBSSxDQUFDLFVBQUEsR0FBRztJQUNQLE9BQU8sR0FBRyxHQUFHLENBQUM7SUFDZCxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQ3hCLENBQUMsQ0FBQztLQUNELEtBQUssQ0FBQyxVQUFBLENBQUM7SUFDTixtQ0FBbUM7SUFDbkMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7SUFDekMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNqQixDQUFDLENBQUMsQ0FBQztBQUVMOztHQUVHO0FBQ0g7SUFHRTtRQUZRLFNBQUksR0FBRyxDQUFDLENBQUM7UUFHZixJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELDJCQUFHLEdBQUg7UUFDRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsZ0NBQVEsR0FBUjtRQUNFLE9BQVUsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFB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LENBQUM7UUFDbEQsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEQsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFdEQsSUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0RSxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFDSCxXQUFDO0FBQUQsQ0FBQyxBQS9KRCxJQStKQztBQS9KWSxvQkFBSSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQHByZXR0aWVyXG4gKiBAaGlkZGVuXG4gKi9cblxuLyoqXG4gKi9cbmltcG9ydCAqIGFzIGJpdGNvaW4gZnJvbSAnYml0Z28tdXR4by1saWInO1xuaW1wb3J0ICogYXMgQmlnIGZyb20gJ2JpZy5qcyc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGRlYnVnTGliIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IEV0aGVyZXVtTGlicmFyeVVuYXZhaWxhYmxlRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xuaW1wb3J0IHsgUmVxdWVzdFRyYWNlciBhcyBJUmVxdWVzdFRyYWNlciB9IGZyb20gJy4uL3R5cGVzJztcblxuY29uc3QgZGVidWcgPSBkZWJ1Z0xpYignYml0Z286djI6dXRpbCcpO1xuXG5sZXQgZXRoVXRpbDtcbmxldCBpc0V0aEF2YWlsYWJsZSA9IGZhbHNlO1xuXG5jb25zdCBldGhJbXBvcnQgPSAnZXRoZXJldW1qcy11dGlsJztcbmltcG9ydCgnZXRoZXJldW1qcy11dGlsJylcbiAgLnRoZW4oZXRoID0+IHtcbiAgICBldGhVdGlsID0gZXRoO1xuICAgIGlzRXRoQXZhaWxhYmxlID0gdHJ1ZTtcbiAgfSlcbiAgLmNhdGNoKGUgPT4ge1xuICAgIC8vIGV0aGVyZXVtIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkXG4gICAgZGVidWcoJ3VuYWJsZSB0byBsb2FkIGV0aGVyZXVtanMtdXRpbDonKTtcbiAgICBkZWJ1ZyhlLnN0YWNrKTtcbiAgfSk7XG5cbi8qKlxuICogQ3JlYXRlIGEgcmVxdWVzdCB0cmFjZXIgZm9yIHRyYWNpbmcgd29ya2Zsb3dzIHdoaWNoIGludm9sdmUgbXVsdGlwbGUgcm91bmQgdHJpcHMgdG8gdGhlIHNlcnZlclxuICovXG5leHBvcnQgY2xhc3MgUmVxdWVzdFRyYWNlciBpbXBsZW1lbnRzIElSZXF1ZXN0VHJhY2VyIHtcbiAgcHJpdmF0ZSBfc2VxID0gMDtcbiAgcHJpdmF0ZSByZWFkb25seSBfc2VlZDogQnVmZmVyO1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9zZWVkID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDEwKTtcbiAgfVxuXG4gIGluYygpIHtcbiAgICB0aGlzLl9zZXErKztcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiBgJHt0aGlzLl9zZWVkLnRvU3RyaW5nKCdoZXgnKX0tJHtfLnBhZFN0YXJ0KHRoaXMuX3NlcS50b1N0cmluZygxNiksIDQsICcwJyl9YDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVXRpbCB7XG4gIHByaXZhdGUgY29uc3RydWN0b3IoKSB7fVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgc3RhdGljIGlzRXRoQXZhaWxhYmxlKCkge1xuICAgIHJldHVybiBpc0V0aEF2YWlsYWJsZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgYmlnLmpzIGJpZyBudW1iZXIgdG8gYW4gYXJyYXkgb2YgdW5zaWduZWQgYnl0ZXNcbiAgICogQHBhcmFtIGJuXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgYm5Ub0J5dGVBcnJheVVuc2lnbmVkKGJuOiBhbnkpOiBhbnkge1xuICAgIGxldCBiYSA9IGJuLmFicygpLnRvQnl0ZUFycmF5KCk7XG4gICAgaWYgKGJhLmxlbmd0aCkge1xuICAgICAgaWYgKGJhWzBdID09PSAwKSB7XG4gICAgICAgIGJhID0gYmEuc2xpY2UoMSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gYmEubWFwKGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgcmV0dXJuIHYgPCAwID8gdiArIDI1NiA6IHY7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRW1wdHkgYXJyYXksIG5vdGhpbmcgdG8gZG9cbiAgICAgIHJldHVybiBiYTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgdGhlIG91dHB1dCBzY3JpcHQgZm9yIGEgQlRDIFAyU0ggbXVsdGlzaWcgYWRkcmVzc1xuICAgKiBAcGFyYW0gbVxuICAgKiBAcGFyYW0gcHViS2V5c1xuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgc3RhdGljIHAyc2hNdWx0aXNpZ091dHB1dFNjcmlwdChtOiBudW1iZXIsIHB1YktleXM6IEJ1ZmZlcltdKSB7XG4gICAgY29uc3QgcmVkZWVtU2NyaXB0ID0gYml0Y29pbi5zY3JpcHQubXVsdGlzaWcub3V0cHV0LmVuY29kZShtLCBwdWJLZXlzKTtcbiAgICBjb25zdCBoYXNoID0gYml0Y29pbi5jcnlwdG8uaGFzaDE2MChyZWRlZW1TY3JpcHQpO1xuICAgIHJldHVybiBiaXRjb2luLnNjcmlwdC5zY3JpcHRIYXNoLm91dHB1dC5lbmNvZGUoaGFzaCk7XG4gIH1cblxuICAvKipcbiAgICogVXRpbGl0eSBtZXRob2QgZm9yIGhhbmRsaW5nIGFyZ3VtZW50cyBvZiBwYWdlYWJsZSBxdWVyaWVzXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIHN0YXRpYyBwcmVwYXJlUGFnZWFibGVRdWVyeShwYXJhbXM6IHsgbGltaXQ/OiBudW1iZXI7IHNraXA/OiBudW1iZXIgfSA9IHt9KTogeyBsaW1pdD86IG51bWJlcjsgc2tpcD86IG51bWJlciB9IHtcbiAgICBjb25zdCBxdWVyeTogYW55ID0ge307XG4gICAgaWYgKHBhcmFtcy5saW1pdCkge1xuICAgICAgaWYgKCFfLmlzTnVtYmVyKHBhcmFtcy5saW1pdCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGxpbWl0IGFyZ3VtZW50LCBleHBlY3RpbmcgbnVtYmVyJyk7XG4gICAgICB9XG4gICAgICBxdWVyeS5saW1pdCA9IHBhcmFtcy5saW1pdDtcbiAgICB9XG4gICAgaWYgKHBhcmFtcy5za2lwKSB7XG4gICAgICBpZiAoIV8uaXNOdW1iZXIocGFyYW1zLnNraXApKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBza2lwIGFyZ3VtZW50LCBleHBlY3RpbmcgbnVtYmVyJyk7XG4gICAgICB9XG4gICAgICBxdWVyeS5za2lwID0gcGFyYW1zLnNraXA7XG4gICAgfVxuICAgIHJldHVybiBxdWVyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSByZXF1ZXN0IGlkZW50aWZpZXIgZm9yIHRyYWNpbmcgbXVsdGktcmVxdWVzdCB3b3JrZmxvd3NcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVSZXF1ZXN0SWQoKTogUmVxdWVzdFRyYWNlciB7XG4gICAgcmV0dXJuIG5ldyBSZXF1ZXN0VHJhY2VyKCk7XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBhIEJUQyB4cHViIHRvIGFuIEV0aGVyZXVtIGFkZHJlc3MgKHdpdGggMHgpIHByZWZpeFxuICAgKiBAcGFyYW0geHB1YlxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgc3RhdGljIHhwdWJUb0V0aEFkZHJlc3MoeHB1Yjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoIWlzRXRoQXZhaWxhYmxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXRoZXJldW1MaWJyYXJ5VW5hdmFpbGFibGVFcnJvcihldGhJbXBvcnQpO1xuICAgIH1cbiAgICBjb25zdCBoZE5vZGUgPSBiaXRjb2luLkhETm9kZS5mcm9tQmFzZTU4KHhwdWIpO1xuICAgIGNvbnN0IGV0aFB1YmxpY0tleSA9IGhkTm9kZS5rZXlQYWlyLl9fUS5nZXRFbmNvZGVkKGZhbHNlKS5zbGljZSgxKTtcbiAgICByZXR1cm4gZXRoVXRpbC5idWZmZXJUb0hleChldGhVdGlsLnB1YmxpY1RvQWRkcmVzcyhldGhQdWJsaWNLZXksIGZhbHNlKSk7XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBhIEJUQyB4cHJpdiB0byBhbiBFdGhlcmV1bSBwcml2YXRlIGtleSAod2l0aG91dCAweCBwcmVmaXgpXG4gICAqIEBwYXJhbSB4cHJ2XG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgeHBydlRvRXRoUHJpdmF0ZUtleSh4cHJ2OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGhkTm9kZSA9IGJpdGNvaW4uSEROb2RlLmZyb21CYXNlNTgoeHBydik7XG4gICAgY29uc3QgZXRoUHJpdmF0ZUtleTogQnVmZmVyID0gaGROb2RlLmtleVBhaXIuZC50b0J1ZmZlcigzMik7XG4gICAgcmV0dXJuIGV0aFByaXZhdGVLZXkudG9TdHJpbmcoJ2hleCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNpZ24gYSBtZXNzYWdlIHVzaW5nIEV0aGVyZXVtJ3MgRUNzaWduIG1ldGhvZCBhbmQgcmV0dXJuIHRoZSBzaWduYXR1cmUgc3RyaW5nXG4gICAqIEBwYXJhbSBtc2dIYXNoXG4gICAqIEBwYXJhbSBwcml2S2V5XG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgZXRoU2lnbk1zZ0hhc2gobXNnSGFzaDogc3RyaW5nLCBwcml2S2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICghaXNFdGhBdmFpbGFibGUpIHtcbiAgICAgIHRocm93IG5ldyBFdGhlcmV1bUxpYnJhcnlVbmF2YWlsYWJsZUVycm9yKGV0aEltcG9ydCk7XG4gICAgfVxuICAgIGNvbnN0IHNpZ25hdHVyZUluUGFydHMgPSBldGhVdGlsLmVjc2lnbihcbiAgICAgIG5ldyBCdWZmZXIoZXRoVXRpbC5zdHJpcEhleFByZWZpeChtc2dIYXNoKSwgJ2hleCcpLFxuICAgICAgbmV3IEJ1ZmZlcihwcml2S2V5LCAnaGV4JylcbiAgICApO1xuXG4gICAgLy8gQXNzZW1ibGUgc3RyaW5ncyBmcm9tIHIsIHMgYW5kIHZcbiAgICBjb25zdCByID0gZXRoVXRpbC5zZXRMZW5ndGhMZWZ0KHNpZ25hdHVyZUluUGFydHMuciwgMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICBjb25zdCBzID0gZXRoVXRpbC5zZXRMZW5ndGhMZWZ0KHNpZ25hdHVyZUluUGFydHMucywgMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICBjb25zdCB2ID0gZXRoVXRpbC5zdHJpcEhleFByZWZpeChldGhVdGlsLmludFRvSGV4KHNpZ25hdHVyZUluUGFydHMudikpO1xuXG4gICAgLy8gQ29uY2F0ZW5hdGUgdGhlIHIsIHMgYW5kIHYgcGFydHMgdG8gbWFrZSB0aGUgc2lnbmF0dXJlIHN0cmluZ1xuICAgIHJldHVybiBldGhVdGlsLmFkZEhleFByZWZpeChyLmNvbmNhdChzLCB2KSk7XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBmcm9tIHdlaSBzdHJpbmcgKG9yIEJOKSB0byBFdGhlciAobXVsdGlwbHkgYnkgMWUxOClcbiAgICogQHBhcmFtIHdlaVxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgc3RhdGljIHdlaVRvRXRoZXJTdHJpbmcod2VpOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICghaXNFdGhBdmFpbGFibGUpIHtcbiAgICAgIHRocm93IG5ldyBFdGhlcmV1bUxpYnJhcnlVbmF2YWlsYWJsZUVycm9yKGV0aEltcG9ydCk7XG4gICAgfVxuICAgIGxldCBibiA9IHdlaTtcbiAgICBpZiAoISh3ZWkgaW5zdGFuY2VvZiBldGhVdGlsLkJOKSkge1xuICAgICAgYm4gPSBuZXcgZXRoVXRpbC5CTih3ZWkpO1xuICAgIH1cbiAgICBCaWcuRV9QT1MgPSAyNTY7XG4gICAgQmlnLkVfTkVHID0gLTE4O1xuICAgIGNvbnN0IHdlaVN0cmluZyA9IGJuLnRvU3RyaW5nKDEwKTtcbiAgICBjb25zdCBiaWcgPSBuZXcgQmlnKHdlaVN0cmluZyk7XG4gICAgLy8gMTBeMThcbiAgICBjb25zdCBldGhlciA9IGJpZy5kaXYoJzEwMDAwMDAwMDAwMDAwMDAwMDAnKTtcbiAgICByZXR1cm4gZXRoZXIudG9QcmVjaXNpb24oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWNvdmVyIGFuIGV0aGVyZXVtIGFkZHJlc3MgZnJvbSBhIHNpZ25hdHVyZSBhbmQgbWVzc2FnZSBoYXNoXG4gICAqIEBwYXJhbSBtc2dIYXNoXG4gICAqIEBwYXJhbSBzaWduYXR1cmVcbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIHN0YXRpYyBlY1JlY292ZXJFdGhBZGRyZXNzKG1zZ0hhc2g6IHN0cmluZywgc2lnbmF0dXJlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIG1zZ0hhc2ggPSBldGhVdGlsLnN0cmlwSGV4UHJlZml4KG1zZ0hhc2gpO1xuICAgIHNpZ25hdHVyZSA9IGV0aFV0aWwuc3RyaXBIZXhQcmVmaXgoc2lnbmF0dXJlKTtcblxuICAgIGNvbnN0IHYgPSBwYXJzZUludChzaWduYXR1cmUuc2xpY2UoMTI4LCAxMzApLCAxNik7XG4gICAgY29uc3QgciA9IG5ldyBCdWZmZXIoc2lnbmF0dXJlLnNsaWNlKDAsIDY0KSwgJ2hleCcpO1xuICAgIGNvbnN0IHMgPSBuZXcgQnVmZmVyKHNpZ25hdHVyZS5zbGljZSg2NCwgMTI4KSwgJ2hleCcpO1xuXG4gICAgY29uc3QgcHViS2V5ID0gZXRoVXRpbC5lY3JlY292ZXIobmV3IEJ1ZmZlcihtc2dIYXNoLCAnaGV4JyksIHYsIHIsIHMpO1xuICAgIHJldHVybiBldGhVdGlsLmJ1ZmZlclRvSGV4KGV0aFV0aWwucHViVG9BZGRyZXNzKHB1YktleSkpO1xuICB9XG59XG4iXX0=