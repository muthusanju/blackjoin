"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
var baseCoin_1 = require("../baseCoin");
var bignumber_js_1 = require("bignumber.js");
var crypto = require("crypto");
var bitgo_utxo_lib_1 = require("bitgo-utxo-lib");
var EosJs = require("eosjs");
var ecc = require("eosjs-ecc");
var url = require("url");
var querystring = require("querystring");
var _ = require("lodash");
var Bluebird = require("bluebird");
var co = Bluebird.coroutine;
var errors_1 = require("../../errors");
var config = require("../../config");
var environments_1 = require("../environments");
var request = require("superagent");
var Eos = /** @class */ (function (_super) {
    __extends(Eos, _super);
    function Eos() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    Eos.createInstance = function (bitgo) {
        return new Eos(bitgo);
    };
    Eos.prototype.getChainId = function () {
        return 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906'; // mainnet chain id
    };
    Eos.prototype.getChain = function () {
        return 'eos';
    };
    Eos.prototype.getFamily = function () {
        return 'eos';
    };
    Eos.prototype.getFullName = function () {
        return 'EOS';
    };
    Eos.prototype.getBaseFactor = function () {
        return 1e4;
    };
    /**
     * Flag for sending value of 0
     * @returns {boolean} True if okay to send 0 value, false otherwise
     */
    Eos.prototype.valuelessTransferAllowed = function () {
        return true;
    };
    /**
     * Get URLs of some active public nodes
     */
    Eos.prototype.getPublicNodeUrls = function () {
        return environments_1.Environments[this.bitgo.getEnv()].eosNodeUrls;
    };
    /**
     * Generate secp256k1 key pair
     *
     * @param seed - Seed from which the new keypair should be generated, otherwise a random seed is used
     */
    Eos.prototype.generateKeyPair = function (seed) {
        if (!seed) {
            // An extended private key has both a normal 256 bit private key and a 256
            // bit chain code, both of which must be random. 512 bits is therefore the
            // maximum entropy and gives us maximum security against cracking.
            seed = crypto.randomBytes(512 / 8);
        }
        var extendedKey = bitgo_utxo_lib_1.HDNode.fromSeedBuffer(seed);
        var xpub = extendedKey.neutered().toBase58();
        return {
            pub: xpub,
            prv: extendedKey.toBase58(),
        };
    };
    /**
     * Return boolean indicating whether input is valid public key for the coin.
     *
     * @param pub - the pub to be checked
     */
    Eos.prototype.isValidPub = function (pub) {
        try {
            bitgo_utxo_lib_1.HDNode.fromBase58(pub);
            return true;
        }
        catch (e) {
            return false;
        }
    };
    /**
     * Return boolean indicating whether input is valid seed for the coin
     *
     * @param prv - the prv to be checked
     */
    Eos.prototype.isValidPrv = function (prv) {
        try {
            bitgo_utxo_lib_1.HDNode.fromBase58(prv);
            return true;
        }
        catch (e) {
            return false;
        }
    };
    /**
     * Evaluates whether a memo is valid
     *
     * @param value - the memo to be checked
     */
    Eos.prototype.isValidMemo = function (_a) {
        var value = _a.value;
        return _.isString(value) && value.length <= 256;
    };
    /**
     * Return boolean indicating whether a memo id is valid
     *
     * @param memoId - the memo id to be checked
     */
    Eos.prototype.isValidMemoId = function (memoId) {
        if (!this.isValidMemo({ value: memoId })) {
            return false;
        }
        var memoIdNumber;
        try {
            memoIdNumber = new bignumber_js_1.BigNumber(memoId);
        }
        catch (e) {
            return false;
        }
        return memoIdNumber.gte(0);
    };
    /**
     * Process address into address and memo id
     * @param address - the address
     */
    Eos.prototype.getAddressDetails = function (address) {
        var destinationDetails = url.parse(address);
        var destinationAddress = destinationDetails.pathname;
        if (!destinationAddress) {
            throw new errors_1.InvalidAddressError("failed to parse address: " + address);
        }
        // EOS addresses have to be "human readable", which means up to 12 characters and only a-z1-5., i.e.mtoda1.bitgo
        // source: https://developers.eos.io/eosio-cpp/docs/naming-conventions
        if (!/^[a-z1-5.]*$/.test(destinationAddress) || destinationAddress.length > Eos.ADDRESS_LENGTH) {
            throw new errors_1.InvalidAddressError("invalid address: " + address);
        }
        // address doesn't have a memo id
        if (destinationDetails.pathname === address) {
            return {
                address: address,
                memoId: undefined,
            };
        }
        if (!destinationDetails.query) {
            throw new errors_1.InvalidAddressError("failed to parse query string: " + address);
        }
        var queryDetails = querystring.parse(destinationDetails.query);
        if (!queryDetails.memoId) {
            // if there are more properties, the query details need to contain the memoId property
            throw new errors_1.InvalidAddressError("invalid property in address: " + address);
        }
        if (Array.isArray(queryDetails.memoId) && queryDetails.memoId.length !== 1) {
            // valid addresses can only contain one memo id
            throw new errors_1.InvalidAddressError("invalid address '" + address + "', must contain exactly one memoId");
        }
        var memoId = _.castArray(queryDetails.memoId)[0];
        if (!this.isValidMemoId(memoId)) {
            throw new errors_1.InvalidAddressError("invalid address: '" + address + "', memoId is not valid");
        }
        return {
            address: destinationAddress,
            memoId: memoId,
        };
    };
    /**
     * Convert a currency amount represented in base units (satoshi, wei, atoms, drops, stroops)
     * to big units (btc, eth, rmg, xrp, xlm)
     */
    Eos.prototype.baseUnitsToBigUnits = function (baseUnits) {
        var dividend = this.getBaseFactor();
        var bigNumber = new bignumber_js_1.BigNumber(baseUnits).dividedBy(dividend);
        // set the format so commas aren't added to large coin amounts
        // @ts-ignore
        return bigNumber.toFormat(4, null, { groupSeparator: '', decimalSeparator: '.' });
    };
    /**
     * Validate and return address with appended memo id
     *
     * @param address
     * @param memoId
     */
    Eos.prototype.normalizeAddress = function (_a) {
        var address = _a.address, memoId = _a.memoId;
        if (memoId && this.isValidMemoId(memoId)) {
            return address + "?memoId=" + memoId;
        }
        return address;
    };
    /**
     * Return boolean indicating whether input is valid public key for the coin
     *
     * @param address - the address to be checked
     */
    Eos.prototype.isValidAddress = function (address) {
        try {
            var addressDetails = this.getAddressDetails(address);
            return address === this.normalizeAddress(addressDetails);
        }
        catch (e) {
            return false;
        }
    };
    /**
     * Check if address is a valid EOS address, then verify it matches the root address.
     *
     * @param address - the address to verify
     * @param rootAddress - the wallet's root address
     */
    Eos.prototype.verifyAddress = function (_a) {
        var address = _a.address, rootAddress = _a.rootAddress;
        if (!rootAddress || !_.isString(rootAddress)) {
            throw new Error('missing required string rootAddress');
        }
        if (!this.isValidAddress(address)) {
            throw new errors_1.InvalidAddressError("invalid address: " + address);
        }
        var addressDetails = this.getAddressDetails(address);
        var rootAddressDetails = this.getAddressDetails(rootAddress);
        if (!addressDetails || !rootAddressDetails) {
            return false;
        }
        if (addressDetails.address !== rootAddressDetails.address) {
            throw new errors_1.UnexpectedAddressError("address validation failure: " + addressDetails.address + " vs " + rootAddressDetails.address);
        }
        return true;
    };
    /**
     * Assemble keychain and half-sign prebuilt transaction
     *
     * @param params
     * @param params.txPrebuild {Object} prebuild object returned by platform
     * @param params.prv {String} user prv
     */
    Eos.prototype.signTransaction = function (params) {
        var prv = params.prv;
        var txHex = params.txPrebuild.txHex;
        var transaction = params.txPrebuild.transaction;
        var signBuffer = Buffer.from(txHex, 'hex');
        var privateKeyBuffer = bitgo_utxo_lib_1.HDNode.fromBase58(prv)
            .getKey()
            .getPrivateKeyBuffer();
        var signature = ecc.Signature.sign(signBuffer, privateKeyBuffer).toString();
        transaction.signatures.push(signature);
        var txParams = {
            transaction: transaction,
            txHex: txHex,
            recipients: params.txPrebuild.recipients,
            headers: params.txPrebuild.headers,
            txid: params.txPrebuild.txid,
        };
        return { halfSigned: txParams };
    };
    Eos.prototype.deserializeStakeAction = function (eosClient, serializedStakeAction) {
        var eosStakeActionStruct = eosClient.fc.abiCache.abi('eosio').structs.delegatebw;
        var serializedStakeActionBuffer = Buffer.from(serializedStakeAction, 'hex');
        var stakeAction = EosJs.modules.Fcbuffer.fromBuffer(eosStakeActionStruct, serializedStakeActionBuffer);
        if (stakeAction.from !== stakeAction.receiver) {
            throw new Error("staker (" + stakeAction.from + ") and receiver (" + stakeAction.receiver + ") must be the same");
        }
        if (stakeAction.transfer !== 0) {
            throw new Error('cannot transfer funds as part of delegatebw action');
        }
        // stake_cpu_quantity is used as the amount because the BitGo platform only stakes cpu for voting transactions
        return {
            address: stakeAction.from,
            amount: this.bigUnitsToBaseUnits(stakeAction.stake_cpu_quantity.split(' ')[0]),
        };
    };
    Eos.deserializeVoteAction = function (eosClient, serializedVoteAction) {
        var eosVoteActionStruct = eosClient.fc.abiCache.abi('eosio').structs.voteproducer;
        var serializedVoteActionBuffer = Buffer.from(serializedVoteAction, 'hex');
        var voteAction = EosJs.modules.Fcbuffer.fromBuffer(eosVoteActionStruct, serializedVoteActionBuffer);
        var proxyIsEmpty = _.isEmpty(voteAction.proxy);
        var producersIsEmpty = _.isEmpty(voteAction.producers);
        if ((proxyIsEmpty && producersIsEmpty) || (!proxyIsEmpty && !producersIsEmpty)) {
            throw new Error('voting transactions must specify either producers or proxy to vote for');
        }
        return { address: voteAction.voter, proxy: voteAction.proxy, producers: voteAction.producers };
    };
    /**
     * Deserialize a transaction
     * @param transaction
     * @param headers
     */
    Eos.prototype.deserializeTransaction = function (_a) {
        var transaction = _a.transaction, headers = _a.headers;
        var self = this;
        return co(function () {
            var eosClientConfig, eosClient, eosTxStruct, serializedTxBuffer, tx, txAction, transferStruct, serializedTransferDataBuffer, transferActionData, txAction2, deserializedStakeAction, deserializedVoteAction, deserializedStakeAction, txAction2, deserializedVoteAction, rebuiltTransaction;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        eosClientConfig = {
                            chainId: self.getChainId(),
                            transactionHeaders: headers,
                        };
                        eosClient = new EosJs(eosClientConfig);
                        eosTxStruct = eosClient.fc.structs.transaction;
                        serializedTxBuffer = Buffer.from(transaction.packed_trx, 'hex');
                        tx = EosJs.modules.Fcbuffer.fromBuffer(eosTxStruct, serializedTxBuffer);
                        // Only support transactions with one (transfer | voteproducer) or two (delegatebw & voteproducer) actions
                        if (tx.actions.length !== 1 && tx.actions.length !== 2) {
                            throw new Error("invalid number of actions: " + tx.actions.length);
                        }
                        txAction = tx.actions[0];
                        if (!txAction) {
                            throw new Error('missing transaction action');
                        }
                        if (txAction.name === 'transfer') {
                            // Transfers should only have 1 action
                            if (tx.actions.length !== 1) {
                                throw new Error("transfers should only have 1 action: " + tx.actions.length + " given");
                            }
                            transferStruct = eosClient.fc.abiCache.abi('eosio.token').structs.transfer;
                            serializedTransferDataBuffer = Buffer.from(txAction.data, 'hex');
                            transferActionData = EosJs.modules.Fcbuffer.fromBuffer(transferStruct, serializedTransferDataBuffer);
                            tx.address = transferActionData.to;
                            tx.amount = this.bigUnitsToBaseUnits(transferActionData.quantity.split(' ')[0]);
                            tx.memo = transferActionData.memo;
                        }
                        else if (txAction.name === 'delegatebw') {
                            // The delegatebw action should only be part of voting transactions
                            if (tx.actions.length !== 2) {
                                throw new Error("staking transactions that include the delegatebw action should have 2 actions: " + tx.actions.length + " given");
                            }
                            txAction2 = tx.actions[1];
                            if (txAction2.name !== 'voteproducer') {
                                throw new Error("invalid staking transaction action: " + txAction2.name + ", expecting: voteproducer");
                            }
                            deserializedStakeAction = self.deserializeStakeAction(eosClient, txAction.data);
                            deserializedVoteAction = Eos.deserializeVoteAction(eosClient, txAction2.data);
                            if (deserializedStakeAction.address !== deserializedVoteAction.address) {
                                throw new Error("staker (" + deserializedStakeAction.address + ") and voter (" + deserializedVoteAction.address + ") must be the same");
                            }
                            tx.amount = deserializedStakeAction.amount;
                            tx.proxy = deserializedVoteAction.proxy;
                            tx.producers = deserializedVoteAction.producers;
                        }
                        else if (txAction.name === 'voteproducer') {
                            if (tx.actions.length > 2) {
                                throw new Error('voting transactions should not have more than 2 actions');
                            }
                            deserializedStakeAction = void 0;
                            if (tx.actions.length === 2) {
                                txAction2 = tx.actions[1];
                                if (txAction2.name !== 'delegatebw') {
                                    throw new Error("invalid staking transaction action: " + txAction2.name + ", expecting: delegatebw");
                                }
                                deserializedStakeAction = self.deserializeStakeAction(eosClient, txAction2.data);
                            }
                            deserializedVoteAction = Eos.deserializeVoteAction(eosClient, txAction.data);
                            if (!!deserializedStakeAction && deserializedStakeAction.address !== deserializedVoteAction.address) {
                                throw new Error("staker (" + deserializedStakeAction.address + ") and voter (" + deserializedVoteAction.address + ") must be the same");
                            }
                            tx.amount = !!deserializedStakeAction ? deserializedStakeAction.amount : '0';
                            tx.proxy = deserializedVoteAction.proxy;
                            tx.producers = deserializedVoteAction.producers;
                        }
                        else {
                            throw new Error("invalid action: " + txAction.name);
                        }
                        if (!headers) return [3 /*break*/, 2];
                        return [4 /*yield*/, eosClient.transaction({ actions: tx.actions }, { sign: false, broadcast: false })];
                    case 1:
                        rebuiltTransaction = _a.sent();
                        tx.transaction_id = rebuiltTransaction.transaction_id;
                        _a.label = 2;
                    case 2: return [2 /*return*/, tx];
                }
            });
        }).call(this);
    };
    /**
     * Explain/parse transaction
     * @param params - ExplainTransactionOptions
     * @param callback
     */
    Eos.prototype.explainTransaction = function (params, callback) {
        var self = this;
        return co(function () {
            var transaction, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, self.deserializeTransaction(params)];
                    case 1:
                        transaction = _a.sent();
                        return [3 /*break*/, 3];
                    case 2:
                        e_1 = _a.sent();
                        throw new Error('invalid EOS transaction or headers');
                    case 3: return [2 /*return*/, {
                            displayOrder: [
                                'id',
                                'outputAmount',
                                'changeAmount',
                                'outputs',
                                'changeOutputs',
                                'fee',
                                'memo',
                                'proxy',
                                'producers',
                            ],
                            id: transaction.transaction_id,
                            changeOutputs: [],
                            outputAmount: transaction.amount,
                            changeAmount: 0,
                            outputs: !!transaction.address ? [{ address: transaction.address, amount: transaction.amount }] : [],
                            fee: {},
                            memo: transaction.memo,
                            proxy: transaction.proxy,
                            producers: transaction.producers,
                        }];
                }
            });
        })
            .call(this)
            .asCallback(callback);
    };
    /**
     * Validate a public or private key
     * If passphrase is provided, try to decrypt the key with it
     * @param key
     * @param source
     * @param passphrase
     * @param isUnsignedSweep
     * @param isKrsRecovery
     */
    Eos.prototype.validateKey = function (_a) {
        var key = _a.key, source = _a.source, passphrase = _a.passphrase, isUnsignedSweep = _a.isUnsignedSweep, isKrsRecovery = _a.isKrsRecovery;
        if (!key.startsWith('xprv') && !isUnsignedSweep) {
            // Try to decrypt the key
            try {
                if (source === 'user' || (source === 'backup' && !isKrsRecovery)) {
                    return bitgo_utxo_lib_1.HDNode.fromBase58(this.bitgo.decrypt({ password: passphrase, input: key }));
                }
            }
            catch (e) {
                throw new Error("Failed to decrypt " + source + " key with passcode - try again!");
            }
        }
        try {
            return bitgo_utxo_lib_1.HDNode.fromBase58(key);
        }
        catch (e) {
            throw new Error("Failed to validate " + source + " key - try again!");
        }
    };
    /**
     * Prepare and validate all keychains from the keycard for recovery
     * @param userKey
     * @param backupKey
     * @param recoveryDestination
     * @param krsProvider
     * @param walletPassphrase
     */
    Eos.prototype.initiateRecovery = function (_a) {
        var userKey = _a.userKey, backupKey = _a.backupKey, recoveryDestination = _a.recoveryDestination, krsProvider = _a.krsProvider, walletPassphrase = _a.walletPassphrase;
        var self = this;
        return co(function () {
            var isKrsRecovery, isUnsignedSweep, krsProviderConfig, keys;
            return __generator(this, function (_a) {
                isKrsRecovery = backupKey.startsWith('xpub') && !userKey.startsWith('xpub');
                isUnsignedSweep = backupKey.startsWith('xpub') && userKey.startsWith('xpub');
                if (isKrsRecovery) {
                    if (!krsProvider || _.isUndefined(config.krsProviders[krsProvider])) {
                        throw new Error('unknown key recovery service provider');
                    }
                    krsProviderConfig = config.krsProviders[krsProvider];
                    if (!krsProviderConfig.supportedCoins.includes(self.getFamily())) {
                        throw new Error('specified key recovery service does not support recoveries for this coin');
                    }
                }
                keys = [
                    self.validateKey({
                        key: userKey,
                        source: 'user',
                        passphrase: walletPassphrase,
                        isKrsRecovery: isKrsRecovery,
                        isUnsignedSweep: isUnsignedSweep,
                    }),
                    self.validateKey({
                        key: backupKey,
                        source: 'backup',
                        passphrase: walletPassphrase,
                        isKrsRecovery: isKrsRecovery,
                        isUnsignedSweep: isUnsignedSweep,
                    }),
                ];
                if (!self.isValidAddress(recoveryDestination)) {
                    throw new Error('Invalid destination address!');
                }
                return [2 /*return*/, keys];
            });
        }).call(this);
    };
    /**
     * Make a request to one of the public EOS nodes available
     * @param endpoint
     * @param payload
     */
    Eos.prototype.getDataFromNode = function (_a) {
        var endpoint = _a.endpoint, payload = _a.payload;
        var self = this;
        return co(function () {
            var nodeUrls, _i, nodeUrls_1, nodeUrl, e_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        nodeUrls = self.getPublicNodeUrls();
                        _i = 0, nodeUrls_1 = nodeUrls;
                        _a.label = 1;
                    case 1:
                        if (!(_i < nodeUrls_1.length)) return [3 /*break*/, 6];
                        nodeUrl = nodeUrls_1[_i];
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 4, , 5]);
                        return [4 /*yield*/, request.post(nodeUrl + endpoint).send(payload)];
                    case 3: return [2 /*return*/, _a.sent()];
                    case 4:
                        e_2 = _a.sent();
                        return [3 /*break*/, 5];
                    case 5:
                        _i++;
                        return [3 /*break*/, 1];
                    case 6: throw new Error("Unable to call endpoint: " + endpoint + " from nodes: " + _.join(nodeUrls, ', '));
                }
            });
        }).call(this);
    };
    /**
     * Get EOS chain info from a public node
     */
    Eos.prototype.getChainInfoFromNode = function () {
        var self = this;
        return co(function () {
            var response;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, self.getDataFromNode({ endpoint: '/v1/chain/get_info' })];
                    case 1:
                        response = _a.sent();
                        if (response.status !== 200) {
                            throw new Error('Unable to fetch chain info');
                        }
                        return [2 /*return*/, response.body];
                }
            });
        }).call(this);
    };
    /**
     * Get data specific to an account from a public node
     * @param address
     */
    Eos.prototype.getAccountFromNode = function (_a) {
        var address = _a.address;
        var self = this;
        return co(function () {
            var response;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, self.getDataFromNode({
                            endpoint: '/v1/chain/get_account',
                            payload: { account_name: address },
                        })];
                    case 1:
                        response = _a.sent();
                        if (response.status !== 200) {
                            throw new Error('Account not found');
                        }
                        return [2 /*return*/, response.body];
                }
            });
        }).call(this);
    };
    /**
     * Get block data from a public node using its block number or block id
     * @param blockNumOrId
     */
    Eos.prototype.getBlockFromNode = function (_a) {
        var blockNumOrId = _a.blockNumOrId;
        var self = this;
        return co(function () {
            var response;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, self.getDataFromNode({
                            endpoint: '/v1/chain/get_block',
                            payload: { block_num_or_id: blockNumOrId },
                        })];
                    case 1:
                        response = _a.sent();
                        if (response.status !== 200) {
                            throw new Error('Block not found');
                        }
                        return [2 /*return*/, response.body];
                }
            });
        }).call(this);
    };
    /**
     * Get headers for an EOS tx from a public node
     */
    Eos.prototype.getTransactionHeadersFromNode = function () {
        var self = this;
        return co(function () {
            var chainInfo, headBlockInfoResult, expireSeconds, chainDate, expirationDate;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, self.getChainInfoFromNode()];
                    case 1:
                        chainInfo = _a.sent();
                        return [4 /*yield*/, self.getBlockFromNode({ blockNumOrId: chainInfo.head_block_num })];
                    case 2:
                        headBlockInfoResult = _a.sent();
                        expireSeconds = 28800;
                        chainDate = new Date(chainInfo.head_block_time + 'Z');
                        expirationDate = new Date(chainDate.getTime() + expireSeconds * 1000);
                        return [2 /*return*/, {
                                expiration: expirationDate.toISOString(),
                                ref_block_num: chainInfo.head_block_num & 0xffff,
                                ref_block_prefix: headBlockInfoResult.ref_block_prefix,
                            }];
                }
            });
        }).call(this);
    };
    Eos.prototype.getTransferAction = function (_a) {
        var recipient = _a.recipient, sender = _a.sender, amount = _a.amount, memo = _a.memo;
        return {
            account: 'eosio.token',
            name: 'transfer',
            authorization: [
                {
                    actor: sender,
                    permission: 'active',
                },
            ],
            data: {
                from: sender,
                to: recipient,
                quantity: this.baseUnitsToBigUnits(amount) + " EOS",
                memo: !_.isNil(memo) ? memo : '',
            },
        };
    };
    /**
     * Sign a transaction with a key
     * @param signableTx
     * @param signingKey
     */
    Eos.prototype.signTx = function (signableTx, signingKey) {
        var signBuffer = Buffer.from(signableTx, 'hex');
        var privateKeyBuffer = signingKey.getKey().getPrivateKeyBuffer();
        return ecc.Signature.sign(signBuffer, privateKeyBuffer).toString();
    };
    /**
     * Serialize an EOS transaction, to the format that should be signed
     * @param eosClient an offline EOSClient that has the transaction structs
     * @param transaction The EOS transaction returned from `eosClient.transaction` to serialize
     * @return {String} serialized transaction in hex format
     */
    Eos.prototype.serializeTransaction = function (eosClient, transaction) {
        var eosTxStruct = eosClient.fc.structs.transaction;
        var txHex = transaction.transaction.transaction;
        var txObject = eosTxStruct.fromObject(txHex);
        return EosJs.modules.Fcbuffer.toBuffer(eosTxStruct, txObject).toString('hex');
    };
    /**
     * Builds a funds recovery transaction without BitGo
     * @param params
     * @param callback
     */
    Eos.prototype.recover = function (params, callback) {
        var self = this;
        return co(function () {
            var isKrsRecovery, isUnsignedSweep, keys, account, userPub, backupPub, activePermission, requiredAuth, foundPubs, requiredAuthKeys, _i, requiredAuthKeys_1, signer, accountBalance, recoveryAmount, destinationAddress, destinationAddressDetails, destinationAccount, transactionHeaders, eosClient, transferAction, transaction, serializedTransaction, txObject, signableTx, userSignature, backupSignature;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!params.rootAddress) {
                            throw new Error('missing required string rootAddress');
                        }
                        isKrsRecovery = params.backupKey.startsWith('xpub') && !params.userKey.startsWith('xpub');
                        isUnsignedSweep = params.backupKey.startsWith('xpub') && params.userKey.startsWith('xpub');
                        return [4 /*yield*/, self.initiateRecovery(params)];
                    case 1:
                        keys = _a.sent();
                        return [4 /*yield*/, self.getAccountFromNode({ address: params.rootAddress })];
                    case 2:
                        account = _a.sent();
                        userPub = ecc.PublicKey.fromBuffer(keys[0].getPublicKeyBuffer()).toString();
                        backupPub = ecc.PublicKey.fromBuffer(keys[1].getPublicKeyBuffer()).toString();
                        activePermission = _.find(account.permissions, { perm_name: 'active' });
                        requiredAuth = _.get(activePermission, 'required_auth');
                        if (!requiredAuth) {
                            throw new Error('Required auth for active permission not found in account');
                        }
                        if (requiredAuth.threshold !== 2) {
                            throw new Error('Unexpected active permission threshold');
                        }
                        foundPubs = {};
                        requiredAuthKeys = requiredAuth.keys;
                        for (_i = 0, requiredAuthKeys_1 = requiredAuthKeys; _i < requiredAuthKeys_1.length; _i++) {
                            signer = requiredAuthKeys_1[_i];
                            if (signer.weight !== 1) {
                                throw new Error('invalid signer weight');
                            }
                            // if it's a dupe of a pub we already know, block
                            if (foundPubs[signer.key]) {
                                throw new Error('duplicate signer key');
                            }
                            foundPubs[signer.key] = (foundPubs[signer.key] || 0) + 1;
                        }
                        if (foundPubs[userPub] !== 1 || foundPubs[backupPub] !== 1) {
                            throw new Error('unexpected incidence frequency of user signer key');
                        }
                        accountBalance = account.core_liquid_balance.split(' ')[0];
                        recoveryAmount = this.bigUnitsToBaseUnits(new bignumber_js_1.BigNumber(accountBalance));
                        destinationAddress = params.recoveryDestination;
                        destinationAddressDetails = self.getAddressDetails(destinationAddress);
                        return [4 /*yield*/, self.getAccountFromNode({ address: destinationAddress })];
                    case 3:
                        destinationAccount = _a.sent();
                        if (!destinationAccount) {
                            throw new Error('Destination account not found');
                        }
                        return [4 /*yield*/, self.getTransactionHeadersFromNode()];
                    case 4:
                        transactionHeaders = _a.sent();
                        eosClient = new EosJs({ chainId: self.getChainId(), transactionHeaders: transactionHeaders });
                        transferAction = self.getTransferAction({
                            recipient: destinationAddressDetails.address,
                            sender: params.rootAddress,
                            amount: new bignumber_js_1.BigNumber(recoveryAmount),
                            memo: destinationAddressDetails.memoId,
                        });
                        return [4 /*yield*/, eosClient.transaction({ actions: [transferAction] }, { sign: false, broadcast: false })];
                    case 5:
                        transaction = _a.sent();
                        serializedTransaction = self.serializeTransaction(eosClient, transaction);
                        txObject = {
                            transaction: {
                                compression: 'none',
                                packed_trx: serializedTransaction,
                                signatures: [],
                            },
                            txid: transaction.transaction_id,
                            recoveryAmount: accountBalance,
                        };
                        signableTx = Buffer.concat([
                            Buffer.from(self.getChainId(), 'hex'),
                            Buffer.from(serializedTransaction, 'hex'),
                            Buffer.from(new Uint8Array(32)),
                        ]).toString('hex');
                        if (isUnsignedSweep) {
                            return [2 /*return*/, txObject];
                        }
                        userSignature = self.signTx(signableTx, keys[0]);
                        txObject.transaction.signatures.push(userSignature);
                        if (!isKrsRecovery) {
                            backupSignature = self.signTx(signableTx, keys[1]);
                            txObject.transaction.signatures.push(backupSignature);
                        }
                        return [2 /*return*/, txObject];
                }
            });
        })
            .call(this)
            .asCallback(callback);
    };
    Eos.prototype.parseTransaction = function (params, callback) {
        return Bluebird.resolve({}).asCallback(callback);
    };
    Eos.prototype.verifyTransaction = function (params, callback) {
        return Bluebird.resolve(true).asCallback(callback);
    };
    /**
     * Generate a random EOS address.
     *
     * This is just a random string which abides by the EOS adddress constraints,
     * and is not actually checked for availability on the EOS blockchain.
     *
     * Current EOS address constraints are:
     * * Address must be exactly 12 characters
     * * Address must only contain lowercase letters and numbers 1-5
     * @returns a validly formatted EOS address, which may or may not actually be available on chain.
     */
    Eos.prototype.generateRandomAddress = function (params) {
        var address = [];
        while (address.length < 12) {
            var char = _.sample(Eos.VALID_ADDRESS_CHARS);
            if (!char) {
                throw new Error('failed to sample valid EOS address characters');
            }
            address.push(char);
        }
        return address.join('');
    };
    Eos.VALID_ADDRESS_CHARS = '12345abcdefghijklmnopqrstuvwxyz'.split('');
    Eos.ADDRESS_LENGTH = 12;
    return Eos;
}(baseCoin_1.BaseCoin));
exports.Eos = Eos;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW9zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3YyL2NvaW5zL2Vvcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFJQSx3Q0FVcUI7QUFFckIsNkNBQXlDO0FBQ3pDLCtCQUFpQztBQUNqQyxpREFBd0M7QUFDeEMsNkJBQStCO0FBQy9CLCtCQUFpQztBQUNqQyx5QkFBMkI7QUFDM0IseUNBQTJDO0FBQzNDLDBCQUE0QjtBQUM1QixtQ0FBcUM7QUFDckMsSUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQztBQUM5Qix1Q0FBMkU7QUFDM0UscUNBQXVDO0FBQ3ZDLGdEQUErQztBQUMvQyxvQ0FBc0M7QUFtSHRDO0lBQXlCLHVCQUFRO0lBQWpDOztJQXd5QkEsQ0FBQztJQXB5QlEsa0JBQWMsR0FBckIsVUFBc0IsS0FBWTtRQUNoQyxPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFFRCx3QkFBVSxHQUFWO1FBQ0UsT0FBTyxrRUFBa0UsQ0FBQyxDQUFDLG1CQUFtQjtJQUNoRyxDQUFDO0lBRUQsc0JBQVEsR0FBUjtRQUNFLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELHVCQUFTLEdBQVQ7UUFDRSxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCx5QkFBVyxHQUFYO1FBQ0UsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsMkJBQWEsR0FBYjtRQUNFLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7T0FHRztJQUNILHNDQUF3QixHQUF4QjtRQUNFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVEOztPQUVHO0lBQ0gsK0JBQWlCLEdBQWpCO1FBQ0UsT0FBTywyQkFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxXQUFXLENB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XG4gKi9cbmltcG9ydCB7IEJpdEdvIH0gZnJvbSAnLi4vLi4vYml0Z28nO1xuaW1wb3J0IHtcbiAgQmFzZUNvaW4sXG4gIFRyYW5zYWN0aW9uRXhwbGFuYXRpb24sXG4gIEtleVBhaXIsXG4gIFBhcnNlVHJhbnNhY3Rpb25PcHRpb25zLFxuICBQYXJzZWRUcmFuc2FjdGlvbixcbiAgVmVyaWZ5VHJhbnNhY3Rpb25PcHRpb25zLFxuICBWZXJpZnlBZGRyZXNzT3B0aW9ucyBhcyBCYXNlVmVyaWZ5QWRkcmVzc09wdGlvbnMsXG4gIEhhbGZTaWduZWRUcmFuc2FjdGlvbiBhcyBCYXNlSGFsZlNpZ25lZFRyYW5zYWN0aW9uLFxuICBTaWduVHJhbnNhY3Rpb25PcHRpb25zIGFzIEJhc2VTaWduVHJhbnNhY3Rpb25PcHRpb25zLFxufSBmcm9tICcuLi9iYXNlQ29pbic7XG5pbXBvcnQgeyBOb2RlQ2FsbGJhY2sgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnO1xuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBIRE5vZGUgfSBmcm9tICdiaXRnby11dHhvLWxpYic7XG5pbXBvcnQgKiBhcyBFb3NKcyBmcm9tICdlb3Nqcyc7XG5pbXBvcnQgKiBhcyBlY2MgZnJvbSAnZW9zanMtZWNjJztcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xuaW1wb3J0ICogYXMgcXVlcnlzdHJpbmcgZnJvbSAncXVlcnlzdHJpbmcnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnO1xuY29uc3QgY28gPSBCbHVlYmlyZC5jb3JvdXRpbmU7XG5pbXBvcnQgeyBJbnZhbGlkQWRkcmVzc0Vycm9yLCBVbmV4cGVjdGVkQWRkcmVzc0Vycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzJztcbmltcG9ydCAqIGFzIGNvbmZpZyBmcm9tICcuLi8uLi9jb25maWcnO1xuaW1wb3J0IHsgRW52aXJvbm1lbnRzIH0gZnJvbSAnLi4vZW52aXJvbm1lbnRzJztcbmltcG9ydCAqIGFzIHJlcXVlc3QgZnJvbSAnc3VwZXJhZ2VudCc7XG5cbmludGVyZmFjZSBBZGRyZXNzRGV0YWlscyB7XG4gIGFkZHJlc3M6IHN0cmluZztcbiAgbWVtb0lkPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVvc1R4IHtcbiAgc2lnbmF0dXJlczogc3RyaW5nW107XG4gIHBhY2tlZF90cng6IHN0cmluZztcbiAgY29tcHJlc3Npb246IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWNpcGllbnQge1xuICBhZGRyZXNzOiBzdHJpbmc7XG4gIGFtb3VudDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgRW9zVHJhbnNhY3Rpb25IZWFkZXJzIHtcbiAgcmVmX2Jsb2NrX3ByZWZpeDogbnVtYmVyO1xuICByZWZfYmxvY2tfbnVtOiBudW1iZXI7XG4gIGV4cGlyYXRpb24/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFb3NUcmFuc2FjdGlvbkFjdGlvbiB7XG4gIGFjY291bnQ6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xuICBhdXRob3JpemF0aW9uOiBbeyBhY3Rvcjogc3RyaW5nOyBwZXJtaXNzaW9uOiBzdHJpbmcgfV07XG4gIGRhdGE6IHsgZnJvbTogc3RyaW5nOyB0bzogc3RyaW5nOyBxdWFudGl0eTogc3RyaW5nOyBtZW1vPzogc3RyaW5nIH07XG59XG5cbmludGVyZmFjZSBFb3NUcmFuc2FjdGlvblByZWJ1aWxkIHtcbiAgcmVjaXBpZW50czogUmVjaXBpZW50W107XG4gIGhlYWRlcnM6IEVvc1RyYW5zYWN0aW9uSGVhZGVycztcbiAgdHhIZXg6IHN0cmluZzsgLy8gVGhlIHNpZ25hYmxlIHR4IGhleCBzdHJpbmdcbiAgdHJhbnNhY3Rpb246IEVvc1R4O1xuICB0eGlkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW9zU2lnblRyYW5zYWN0aW9uUGFyYW1zIGV4dGVuZHMgQmFzZVNpZ25UcmFuc2FjdGlvbk9wdGlvbnMge1xuICBwcnY6IHN0cmluZztcbiAgdHhQcmVidWlsZDogRW9zVHJhbnNhY3Rpb25QcmVidWlsZDtcbiAgcmVjaXBpZW50czogUmVjaXBpZW50W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW9zSGFsZlNpZ25lZCB7XG4gIHJlY2lwaWVudHM6IFJlY2lwaWVudFtdO1xuICBoZWFkZXJzOiBFb3NUcmFuc2FjdGlvbkhlYWRlcnM7XG4gIHR4SGV4OiBzdHJpbmc7IC8vIFRoZSBzaWduYWJsZSB0eCBoZXggc3RyaW5nXG4gIHRyYW5zYWN0aW9uOiBFb3NUeDtcbiAgdHhpZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVvc1NpZ25lZFRyYW5zYWN0aW9uIGV4dGVuZHMgQmFzZUhhbGZTaWduZWRUcmFuc2FjdGlvbiB7XG4gIGhhbGZTaWduZWQ6IEVvc0hhbGZTaWduZWQ7XG59XG5cbmludGVyZmFjZSBEZXNlcmlhbGl6ZWRFb3NUcmFuc2FjdGlvbiBleHRlbmRzIEVvc1RyYW5zYWN0aW9uSGVhZGVycyB7XG4gIG1heF9uZXRfdXNhZ2Vfd29yZHM6IG51bWJlcjtcbiAgbWF4X2NwdV91c2FnZV9tczogbnVtYmVyO1xuICBkZWxheV9zZWM6IG51bWJlcjtcbiAgY29udGV4dF9mcmVlX2FjdGlvbnM6IEVvc1RyYW5zYWN0aW9uQWN0aW9uW107XG4gIGFjdGlvbnM6IEVvc1RyYW5zYWN0aW9uQWN0aW9uW107XG4gIHRyYW5zYWN0aW9uX2V4dGVuc2lvbnM6IG9iamVjdFtdO1xuICBhZGRyZXNzOiBzdHJpbmc7XG4gIGFtb3VudDogc3RyaW5nO1xuICB0cmFuc2FjdGlvbl9pZDogc3RyaW5nO1xuICBtZW1vPzogc3RyaW5nO1xuICBwcm94eT86IHN0cmluZztcbiAgcHJvZHVjZXJzPzogc3RyaW5nW107XG59XG5cbmludGVyZmFjZSBEZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbiB7XG4gIGFkZHJlc3M6IHN0cmluZztcbiAgYW1vdW50OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBEZXNlcmlhbGl6ZWRWb3RlQWN0aW9uIHtcbiAgYWRkcmVzczogc3RyaW5nO1xuICBwcm94eTogc3RyaW5nO1xuICBwcm9kdWNlcnM6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgRXhwbGFpblRyYW5zYWN0aW9uT3B0aW9ucyB7XG4gIHRyYW5zYWN0aW9uOiB7IHBhY2tlZF90cng6IHN0cmluZyB9O1xuICBoZWFkZXJzOiBFb3NUcmFuc2FjdGlvbkhlYWRlcnM7XG59XG5cbmludGVyZmFjZSBSZWNvdmVyeVRyYW5zYWN0aW9uIHtcbiAgdHJhbnNhY3Rpb246IEVvc1R4O1xuICB0eGlkOiBzdHJpbmc7XG4gIHJlY292ZXJ5QW1vdW50OiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBSZWNvdmVyeU9wdGlvbnMge1xuICB1c2VyS2V5OiBzdHJpbmc7IC8vIEJveCBBXG4gIGJhY2t1cEtleTogc3RyaW5nOyAvLyBCb3ggQlxuICBiaXRnb0tleT86IHN0cmluZzsgLy8gQm94IENcbiAgcmVjb3ZlcnlEZXN0aW5hdGlvbjogc3RyaW5nO1xuICBrcnNQcm92aWRlcj86IHN0cmluZztcbiAgd2FsbGV0UGFzc3BocmFzZT86IHN0cmluZztcbiAgcm9vdEFkZHJlc3M/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBWYWxpZGF0ZUtleU9wdGlvbnMge1xuICBrZXk6IHN0cmluZztcbiAgc291cmNlOiBzdHJpbmc7XG4gIHBhc3NwaHJhc2U/OiBzdHJpbmc7XG4gIGlzVW5zaWduZWRTd2VlcDogYm9vbGVhbjtcbiAgaXNLcnNSZWNvdmVyeTogYm9vbGVhbjtcbn1cbmludGVyZmFjZSBWZXJpZnlBZGRyZXNzT3B0aW9ucyBleHRlbmRzIEJhc2VWZXJpZnlBZGRyZXNzT3B0aW9ucyB7XG4gIHJvb3RBZGRyZXNzOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBFb3MgZXh0ZW5kcyBCYXNlQ29pbiB7XG4gIHB1YmxpYyBzdGF0aWMgVkFMSURfQUREUkVTU19DSEFSUyA9ICcxMjM0NWFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6Jy5zcGxpdCgnJyk7XG4gIHB1YmxpYyBzdGF0aWMgQUREUkVTU19MRU5HVEggPSAxMjtcblxuICBzdGF0aWMgY3JlYXRlSW5zdGFuY2UoYml0Z286IEJpdEdvKTogQmFzZUNvaW4ge1xuICAgIHJldHVybiBuZXcgRW9zKGJpdGdvKTtcbiAgfVxuXG4gIGdldENoYWluSWQoKSB7XG4gICAgcmV0dXJuICdhY2EzNzZmMjA2YjhmYzI1YTZlZDQ0ZGJkYzY2NTQ3YzM2YzZjMzNlM2ExMTlmZmJlYWVmOTQzNjQyZjBlOTA2JzsgLy8gbWFpbm5ldCBjaGFpbiBpZFxuICB9XG5cbiAgZ2V0Q2hhaW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gJ2Vvcyc7XG4gIH1cblxuICBnZXRGYW1pbHkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gJ2Vvcyc7XG4gIH1cblxuICBnZXRGdWxsTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAnRU9TJztcbiAgfVxuXG4gIGdldEJhc2VGYWN0b3IoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gMWU0O1xuICB9XG5cbiAgLyoqXG4gICAqIEZsYWcgZm9yIHNlbmRpbmcgdmFsdWUgb2YgMFxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBva2F5IHRvIHNlbmQgMCB2YWx1ZSwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAqL1xuICB2YWx1ZWxlc3NUcmFuc2ZlckFsbG93ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IFVSTHMgb2Ygc29tZSBhY3RpdmUgcHVibGljIG5vZGVzXG4gICAqL1xuICBnZXRQdWJsaWNOb2RlVXJscygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIEVudmlyb25tZW50c1t0aGlzLmJpdGdvLmdldEVudigpXS5lb3NOb2RlVXJscztcbiAgfVxuICAvKipcbiAgICogR2VuZXJhdGUgc2VjcDI1NmsxIGtleSBwYWlyXG4gICAqXG4gICAqIEBwYXJhbSBzZWVkIC0gU2VlZCBmcm9tIHdoaWNoIHRoZSBuZXcga2V5cGFpciBzaG91bGQgYmUgZ2VuZXJhdGVkLCBvdGhlcndpc2UgYSByYW5kb20gc2VlZCBpcyB1c2VkXG4gICAqL1xuICBnZW5lcmF0ZUtleVBhaXIoc2VlZD86IEJ1ZmZlcik6IEtleVBhaXIge1xuICAgIGlmICghc2VlZCkge1xuICAgICAgLy8gQW4gZXh0ZW5kZWQgcHJpdmF0ZSBrZXkgaGFzIGJvdGggYSBub3JtYWwgMjU2IGJpdCBwcml2YXRlIGtleSBhbmQgYSAyNTZcbiAgICAgIC8vIGJpdCBjaGFpbiBjb2RlLCBib3RoIG9mIHdoaWNoIG11c3QgYmUgcmFuZG9tLiA1MTIgYml0cyBpcyB0aGVyZWZvcmUgdGhlXG4gICAgICAvLyBtYXhpbXVtIGVudHJvcHkgYW5kIGdpdmVzIHVzIG1heGltdW0gc2VjdXJpdHkgYWdhaW5zdCBjcmFja2luZy5cbiAgICAgIHNlZWQgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoNTEyIC8gOCk7XG4gICAgfVxuICAgIGNvbnN0IGV4dGVuZGVkS2V5ID0gSEROb2RlLmZyb21TZWVkQnVmZmVyKHNlZWQpO1xuICAgIGNvbnN0IHhwdWIgPSBleHRlbmRlZEtleS5uZXV0ZXJlZCgpLnRvQmFzZTU4KCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHB1YjogeHB1YixcbiAgICAgIHBydjogZXh0ZW5kZWRLZXkudG9CYXNlNTgoKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciBpbnB1dCBpcyB2YWxpZCBwdWJsaWMga2V5IGZvciB0aGUgY29pbi5cbiAgICpcbiAgICogQHBhcmFtIHB1YiAtIHRoZSBwdWIgdG8gYmUgY2hlY2tlZFxuICAgKi9cbiAgaXNWYWxpZFB1YihwdWI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBIRE5vZGUuZnJvbUJhc2U1OChwdWIpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgaW5wdXQgaXMgdmFsaWQgc2VlZCBmb3IgdGhlIGNvaW5cbiAgICpcbiAgICogQHBhcmFtIHBydiAtIHRoZSBwcnYgdG8gYmUgY2hlY2tlZFxuICAgKi9cbiAgaXNWYWxpZFBydihwcnY6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBIRE5vZGUuZnJvbUJhc2U1OChwcnYpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFdmFsdWF0ZXMgd2hldGhlciBhIG1lbW8gaXMgdmFsaWRcbiAgICpcbiAgICogQHBhcmFtIHZhbHVlIC0gdGhlIG1lbW8gdG8gYmUgY2hlY2tlZFxuICAgKi9cbiAgaXNWYWxpZE1lbW8oeyB2YWx1ZSB9OiB7IHZhbHVlOiBzdHJpbmcgfSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBfLmlzU3RyaW5nKHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPD0gMjU2O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciBhIG1lbW8gaWQgaXMgdmFsaWRcbiAgICpcbiAgICogQHBhcmFtIG1lbW9JZCAtIHRoZSBtZW1vIGlkIHRvIGJlIGNoZWNrZWRcbiAgICovXG4gIGlzVmFsaWRNZW1vSWQobWVtb0lkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAoIXRoaXMuaXNWYWxpZE1lbW8oeyB2YWx1ZTogbWVtb0lkIH0pKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgbGV0IG1lbW9JZE51bWJlcjtcbiAgICB0cnkge1xuICAgICAgbWVtb0lkTnVtYmVyID0gbmV3IEJpZ051bWJlcihtZW1vSWQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVtb0lkTnVtYmVyLmd0ZSgwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzIGFkZHJlc3MgaW50byBhZGRyZXNzIGFuZCBtZW1vIGlkXG4gICAqIEBwYXJhbSBhZGRyZXNzIC0gdGhlIGFkZHJlc3NcbiAgICovXG4gIGdldEFkZHJlc3NEZXRhaWxzKGFkZHJlc3M6IHN0cmluZyk6IEFkZHJlc3NEZXRhaWxzIHtcbiAgICBjb25zdCBkZXN0aW5hdGlvbkRldGFpbHMgPSB1cmwucGFyc2UoYWRkcmVzcyk7XG4gICAgY29uc3QgZGVzdGluYXRpb25BZGRyZXNzID0gZGVzdGluYXRpb25EZXRhaWxzLnBhdGhuYW1lO1xuXG4gICAgaWYgKCFkZXN0aW5hdGlvbkFkZHJlc3MpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkQWRkcmVzc0Vycm9yKGBmYWlsZWQgdG8gcGFyc2UgYWRkcmVzczogJHthZGRyZXNzfWApO1xuICAgIH1cblxuICAgIC8vIEVPUyBhZGRyZXNzZXMgaGF2ZSB0byBiZSBcImh1bWFuIHJlYWRhYmxlXCIsIHdoaWNoIG1lYW5zIHVwIHRvIDEyIGNoYXJhY3RlcnMgYW5kIG9ubHkgYS16MS01LiwgaS5lLm10b2RhMS5iaXRnb1xuICAgIC8vIHNvdXJjZTogaHR0cHM6Ly9kZXZlbG9wZXJzLmVvcy5pby9lb3Npby1jcHAvZG9jcy9uYW1pbmctY29udmVudGlvbnNcbiAgICBpZiAoIS9eW2EtejEtNS5dKiQvLnRlc3QoZGVzdGluYXRpb25BZGRyZXNzKSB8fCBkZXN0aW5hdGlvbkFkZHJlc3MubGVuZ3RoID4gRW9zLkFERFJFU1NfTEVOR1RIKSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZEFkZHJlc3NFcnJvcihgaW52YWxpZCBhZGRyZXNzOiAke2FkZHJlc3N9YCk7XG4gICAgfVxuXG4gICAgLy8gYWRkcmVzcyBkb2Vzbid0IGhhdmUgYSBtZW1vIGlkXG4gICAgaWYgKGRlc3RpbmF0aW9uRGV0YWlscy5wYXRobmFtZSA9PT0gYWRkcmVzcykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWRkcmVzczogYWRkcmVzcyxcbiAgICAgICAgbWVtb0lkOiB1bmRlZmluZWQsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmICghZGVzdGluYXRpb25EZXRhaWxzLnF1ZXJ5KSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZEFkZHJlc3NFcnJvcihgZmFpbGVkIHRvIHBhcnNlIHF1ZXJ5IHN0cmluZzogJHthZGRyZXNzfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHF1ZXJ5RGV0YWlscyA9IHF1ZXJ5c3RyaW5nLnBhcnNlKGRlc3RpbmF0aW9uRGV0YWlscy5xdWVyeSk7XG4gICAgaWYgKCFxdWVyeURldGFpbHMubWVtb0lkKSB7XG4gICAgICAvLyBpZiB0aGVyZSBhcmUgbW9yZSBwcm9wZXJ0aWVzLCB0aGUgcXVlcnkgZGV0YWlscyBuZWVkIHRvIGNvbnRhaW4gdGhlIG1lbW9JZCBwcm9wZXJ0eVxuICAgICAgdGhyb3cgbmV3IEludmFsaWRBZGRyZXNzRXJyb3IoYGludmFsaWQgcHJvcGVydHkgaW4gYWRkcmVzczogJHthZGRyZXNzfWApO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHF1ZXJ5RGV0YWlscy5tZW1vSWQpICYmIHF1ZXJ5RGV0YWlscy5tZW1vSWQubGVuZ3RoICE9PSAxKSB7XG4gICAgICAvLyB2YWxpZCBhZGRyZXNzZXMgY2FuIG9ubHkgY29udGFpbiBvbmUgbWVtbyBpZFxuICAgICAgdGhyb3cgbmV3IEludmFsaWRBZGRyZXNzRXJyb3IoYGludmFsaWQgYWRkcmVzcyAnJHthZGRyZXNzfScsIG11c3QgY29udGFpbiBleGFjdGx5IG9uZSBtZW1vSWRgKTtcbiAgICB9XG5cbiAgICBjb25zdCBbbWVtb0lkXSA9IF8uY2FzdEFycmF5KHF1ZXJ5RGV0YWlscy5tZW1vSWQpO1xuICAgIGlmICghdGhpcy5pc1ZhbGlkTWVtb0lkKG1lbW9JZCkpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkQWRkcmVzc0Vycm9yKGBpbnZhbGlkIGFkZHJlc3M6ICcke2FkZHJlc3N9JywgbWVtb0lkIGlzIG5vdCB2YWxpZGApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBhZGRyZXNzOiBkZXN0aW5hdGlvbkFkZHJlc3MsXG4gICAgICBtZW1vSWQsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgY3VycmVuY3kgYW1vdW50IHJlcHJlc2VudGVkIGluIGJhc2UgdW5pdHMgKHNhdG9zaGksIHdlaSwgYXRvbXMsIGRyb3BzLCBzdHJvb3BzKVxuICAgKiB0byBiaWcgdW5pdHMgKGJ0YywgZXRoLCBybWcsIHhycCwgeGxtKVxuICAgKi9cbiAgYmFzZVVuaXRzVG9CaWdVbml0cyhiYXNlVW5pdHM6IHN0cmluZyB8IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3QgZGl2aWRlbmQgPSB0aGlzLmdldEJhc2VGYWN0b3IoKTtcbiAgICBjb25zdCBiaWdOdW1iZXIgPSBuZXcgQmlnTnVtYmVyKGJhc2VVbml0cykuZGl2aWRlZEJ5KGRpdmlkZW5kKTtcbiAgICAvLyBzZXQgdGhlIGZvcm1hdCBzbyBjb21tYXMgYXJlbid0IGFkZGVkIHRvIGxhcmdlIGNvaW4gYW1vdW50c1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gYmlnTnVtYmVyLnRvRm9ybWF0KDQsIG51bGwsIHsgZ3JvdXBTZXBhcmF0b3I6ICcnLCBkZWNpbWFsU2VwYXJhdG9yOiAnLicgfSk7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgYW5kIHJldHVybiBhZGRyZXNzIHdpdGggYXBwZW5kZWQgbWVtbyBpZFxuICAgKlxuICAgKiBAcGFyYW0gYWRkcmVzc1xuICAgKiBAcGFyYW0gbWVtb0lkXG4gICAqL1xuICBub3JtYWxpemVBZGRyZXNzKHsgYWRkcmVzcywgbWVtb0lkIH06IEFkZHJlc3NEZXRhaWxzKTogc3RyaW5nIHtcbiAgICBpZiAobWVtb0lkICYmIHRoaXMuaXNWYWxpZE1lbW9JZChtZW1vSWQpKSB7XG4gICAgICByZXR1cm4gYCR7YWRkcmVzc30/bWVtb0lkPSR7bWVtb0lkfWA7XG4gICAgfVxuICAgIHJldHVybiBhZGRyZXNzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciBpbnB1dCBpcyB2YWxpZCBwdWJsaWMga2V5IGZvciB0aGUgY29pblxuICAgKlxuICAgKiBAcGFyYW0gYWRkcmVzcyAtIHRoZSBhZGRyZXNzIHRvIGJlIGNoZWNrZWRcbiAgICovXG4gIGlzVmFsaWRBZGRyZXNzKGFkZHJlc3M6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhZGRyZXNzRGV0YWlscyA9IHRoaXMuZ2V0QWRkcmVzc0RldGFpbHMoYWRkcmVzcyk7XG4gICAgICByZXR1cm4gYWRkcmVzcyA9PT0gdGhpcy5ub3JtYWxpemVBZGRyZXNzKGFkZHJlc3NEZXRhaWxzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGFkZHJlc3MgaXMgYSB2YWxpZCBFT1MgYWRkcmVzcywgdGhlbiB2ZXJpZnkgaXQgbWF0Y2hlcyB0aGUgcm9vdCBhZGRyZXNzLlxuICAgKlxuICAgKiBAcGFyYW0gYWRkcmVzcyAtIHRoZSBhZGRyZXNzIHRvIHZlcmlmeVxuICAgKiBAcGFyYW0gcm9vdEFkZHJlc3MgLSB0aGUgd2FsbGV0J3Mgcm9vdCBhZGRyZXNzXG4gICAqL1xuICB2ZXJpZnlBZGRyZXNzKHsgYWRkcmVzcywgcm9vdEFkZHJlc3MgfTogVmVyaWZ5QWRkcmVzc09wdGlvbnMpOiBib29sZWFuIHtcbiAgICBpZiAoIXJvb3RBZGRyZXNzIHx8ICFfLmlzU3RyaW5nKHJvb3RBZGRyZXNzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nIHJlcXVpcmVkIHN0cmluZyByb290QWRkcmVzcycpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pc1ZhbGlkQWRkcmVzcyhhZGRyZXNzKSkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRBZGRyZXNzRXJyb3IoYGludmFsaWQgYWRkcmVzczogJHthZGRyZXNzfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGFkZHJlc3NEZXRhaWxzID0gdGhpcy5nZXRBZGRyZXNzRGV0YWlscyhhZGRyZXNzKTtcbiAgICBjb25zdCByb290QWRkcmVzc0RldGFpbHMgPSB0aGlzLmdldEFkZHJlc3NEZXRhaWxzKHJvb3RBZGRyZXNzKTtcblxuICAgIGlmICghYWRkcmVzc0RldGFpbHMgfHwgIXJvb3RBZGRyZXNzRGV0YWlscykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChhZGRyZXNzRGV0YWlscy5hZGRyZXNzICE9PSByb290QWRkcmVzc0RldGFpbHMuYWRkcmVzcykge1xuICAgICAgdGhyb3cgbmV3IFVuZXhwZWN0ZWRBZGRyZXNzRXJyb3IoXG4gICAgICAgIGBhZGRyZXNzIHZhbGlkYXRpb24gZmFpbHVyZTogJHthZGRyZXNzRGV0YWlscy5hZGRyZXNzfSB2cyAke3Jvb3RBZGRyZXNzRGV0YWlscy5hZGRyZXNzfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogQXNzZW1ibGUga2V5Y2hhaW4gYW5kIGhhbGYtc2lnbiBwcmVidWlsdCB0cmFuc2FjdGlvblxuICAgKlxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqIEBwYXJhbSBwYXJhbXMudHhQcmVidWlsZCB7T2JqZWN0fSBwcmVidWlsZCBvYmplY3QgcmV0dXJuZWQgYnkgcGxhdGZvcm1cbiAgICogQHBhcmFtIHBhcmFtcy5wcnYge1N0cmluZ30gdXNlciBwcnZcbiAgICovXG4gIHNpZ25UcmFuc2FjdGlvbihwYXJhbXM6IEVvc1NpZ25UcmFuc2FjdGlvblBhcmFtcyk6IEVvc1NpZ25lZFRyYW5zYWN0aW9uIHtcbiAgICBjb25zdCBwcnY6IHN0cmluZyA9IHBhcmFtcy5wcnY7XG4gICAgY29uc3QgdHhIZXg6IHN0cmluZyA9IHBhcmFtcy50eFByZWJ1aWxkLnR4SGV4O1xuICAgIGNvbnN0IHRyYW5zYWN0aW9uOiBFb3NUeCA9IHBhcmFtcy50eFByZWJ1aWxkLnRyYW5zYWN0aW9uO1xuXG4gICAgY29uc3Qgc2lnbkJ1ZmZlcjogQnVmZmVyID0gQnVmZmVyLmZyb20odHhIZXgsICdoZXgnKTtcbiAgICBjb25zdCBwcml2YXRlS2V5QnVmZmVyOiBCdWZmZXIgPSBIRE5vZGUuZnJvbUJhc2U1OChwcnYpXG4gICAgICAuZ2V0S2V5KClcbiAgICAgIC5nZXRQcml2YXRlS2V5QnVmZmVyKCk7XG4gICAgY29uc3Qgc2lnbmF0dXJlOiBzdHJpbmcgPSBlY2MuU2lnbmF0dXJlLnNpZ24oc2lnbkJ1ZmZlciwgcHJpdmF0ZUtleUJ1ZmZlcikudG9TdHJpbmcoKTtcblxuICAgIHRyYW5zYWN0aW9uLnNpZ25hdHVyZXMucHVzaChzaWduYXR1cmUpO1xuXG4gICAgY29uc3QgdHhQYXJhbXMgPSB7XG4gICAgICB0cmFuc2FjdGlvbixcbiAgICAgIHR4SGV4LFxuICAgICAgcmVjaXBpZW50czogcGFyYW1zLnR4UHJlYnVpbGQucmVjaXBpZW50cyxcbiAgICAgIGhlYWRlcnM6IHBhcmFtcy50eFByZWJ1aWxkLmhlYWRlcnMsXG4gICAgICB0eGlkOiBwYXJhbXMudHhQcmVidWlsZC50eGlkLFxuICAgIH07XG4gICAgcmV0dXJuIHsgaGFsZlNpZ25lZDogdHhQYXJhbXMgfTtcbiAgfVxuXG4gIHByaXZhdGUgZGVzZXJpYWxpemVTdGFrZUFjdGlvbihlb3NDbGllbnQ6IEVvc0pzLCBzZXJpYWxpemVkU3Rha2VBY3Rpb246IHN0cmluZyk6IERlc2VyaWFsaXplZFN0YWtlQWN0aW9uIHtcbiAgICBjb25zdCBlb3NTdGFrZUFjdGlvblN0cnVjdCA9IGVvc0NsaWVudC5mYy5hYmlDYWNoZS5hYmkoJ2Vvc2lvJykuc3RydWN0cy5kZWxlZ2F0ZWJ3O1xuICAgIGNvbnN0IHNlcmlhbGl6ZWRTdGFrZUFjdGlvbkJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHNlcmlhbGl6ZWRTdGFrZUFjdGlvbiwgJ2hleCcpO1xuICAgIGNvbnN0IHN0YWtlQWN0aW9uID0gRW9zSnMubW9kdWxlcy5GY2J1ZmZlci5mcm9tQnVmZmVyKGVvc1N0YWtlQWN0aW9uU3RydWN0LCBzZXJpYWxpemVkU3Rha2VBY3Rpb25CdWZmZXIpO1xuXG4gICAgaWYgKHN0YWtlQWN0aW9uLmZyb20gIT09IHN0YWtlQWN0aW9uLnJlY2VpdmVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHN0YWtlciAoJHtzdGFrZUFjdGlvbi5mcm9tfSkgYW5kIHJlY2VpdmVyICgke3N0YWtlQWN0aW9uLnJlY2VpdmVyfSkgbXVzdCBiZSB0aGUgc2FtZWApO1xuICAgIH1cblxuICAgIGlmIChzdGFrZUFjdGlvbi50cmFuc2ZlciAhPT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5ub3QgdHJhbnNmZXIgZnVuZHMgYXMgcGFydCBvZiBkZWxlZ2F0ZWJ3IGFjdGlvbicpO1xuICAgIH1cblxuICAgIC8vIHN0YWtlX2NwdV9xdWFudGl0eSBpcyB1c2VkIGFzIHRoZSBhbW91bnQgYmVjYXVzZSB0aGUgQml0R28gcGxhdGZvcm0gb25seSBzdGFrZXMgY3B1IGZvciB2b3RpbmcgdHJhbnNhY3Rpb25zXG4gICAgcmV0dXJuIHtcbiAgICAgIGFkZHJlc3M6IHN0YWtlQWN0aW9uLmZyb20sXG4gICAgICBhbW91bnQ6IHRoaXMuYmlnVW5pdHNUb0Jhc2VVbml0cyhzdGFrZUFjdGlvbi5zdGFrZV9jcHVfcXVhbnRpdHkuc3BsaXQoJyAnKVswXSksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGRlc2VyaWFsaXplVm90ZUFjdGlvbihlb3NDbGllbnQ6IEVvc0pzLCBzZXJpYWxpemVkVm90ZUFjdGlvbjogc3RyaW5nKTogRGVzZXJpYWxpemVkVm90ZUFjdGlvbiB7XG4gICAgY29uc3QgZW9zVm90ZUFjdGlvblN0cnVjdCA9IGVvc0NsaWVudC5mYy5hYmlDYWNoZS5hYmkoJ2Vvc2lvJykuc3RydWN0cy52b3RlcHJvZHVjZXI7XG4gICAgY29uc3Qgc2VyaWFsaXplZFZvdGVBY3Rpb25CdWZmZXIgPSBCdWZmZXIuZnJvbShzZXJpYWxpemVkVm90ZUFjdGlvbiwgJ2hleCcpO1xuICAgIGNvbnN0IHZvdGVBY3Rpb24gPSBFb3NKcy5tb2R1bGVzLkZjYnVmZmVyLmZyb21CdWZmZXIoZW9zVm90ZUFjdGlvblN0cnVjdCwgc2VyaWFsaXplZFZvdGVBY3Rpb25CdWZmZXIpO1xuXG4gICAgY29uc3QgcHJveHlJc0VtcHR5ID0gXy5pc0VtcHR5KHZvdGVBY3Rpb24ucHJveHkpO1xuICAgIGNvbnN0IHByb2R1Y2Vyc0lzRW1wdHkgPSBfLmlzRW1wdHkodm90ZUFjdGlvbi5wcm9kdWNlcnMpO1xuICAgIGlmICgocHJveHlJc0VtcHR5ICYmIHByb2R1Y2Vyc0lzRW1wdHkpIHx8ICghcHJveHlJc0VtcHR5ICYmICFwcm9kdWNlcnNJc0VtcHR5KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd2b3RpbmcgdHJhbnNhY3Rpb25zIG11c3Qgc3BlY2lmeSBlaXRoZXIgcHJvZHVjZXJzIG9yIHByb3h5IHRvIHZvdGUgZm9yJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgYWRkcmVzczogdm90ZUFjdGlvbi52b3RlciwgcHJveHk6IHZvdGVBY3Rpb24ucHJveHksIHByb2R1Y2Vyczogdm90ZUFjdGlvbi5wcm9kdWNlcnMgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXNlcmlhbGl6ZSBhIHRyYW5zYWN0aW9uXG4gICAqIEBwYXJhbSB0cmFuc2FjdGlvblxuICAgKiBAcGFyYW0gaGVhZGVyc1xuICAgKi9cbiAgcHJpdmF0ZSBkZXNlcmlhbGl6ZVRyYW5zYWN0aW9uKHtcbiAgICB0cmFuc2FjdGlvbixcbiAgICBoZWFkZXJzLFxuICB9OiBFeHBsYWluVHJhbnNhY3Rpb25PcHRpb25zKTogQmx1ZWJpcmQ8RGVzZXJpYWxpemVkRW9zVHJhbnNhY3Rpb24+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gY288RGVzZXJpYWxpemVkRW9zVHJhbnNhY3Rpb24+KGZ1bmN0aW9uKigpIHtcbiAgICAgIGNvbnN0IGVvc0NsaWVudENvbmZpZyA9IHtcbiAgICAgICAgY2hhaW5JZDogc2VsZi5nZXRDaGFpbklkKCksXG4gICAgICAgIHRyYW5zYWN0aW9uSGVhZGVyczogaGVhZGVycyxcbiAgICAgIH07XG4gICAgICBjb25zdCBlb3NDbGllbnQgPSBuZXcgRW9zSnMoZW9zQ2xpZW50Q29uZmlnKTtcblxuICAgICAgLy8gR2V0IHR4IGJhc2UgdmFsdWVzXG4gICAgICBjb25zdCBlb3NUeFN0cnVjdCA9IGVvc0NsaWVudC5mYy5zdHJ1Y3RzLnRyYW5zYWN0aW9uO1xuICAgICAgY29uc3Qgc2VyaWFsaXplZFR4QnVmZmVyID0gQnVmZmVyLmZyb20odHJhbnNhY3Rpb24ucGFja2VkX3RyeCwgJ2hleCcpO1xuICAgICAgY29uc3QgdHggPSBFb3NKcy5tb2R1bGVzLkZjYnVmZmVyLmZyb21CdWZmZXIoZW9zVHhTdHJ1Y3QsIHNlcmlhbGl6ZWRUeEJ1ZmZlcik7XG5cbiAgICAgIC8vIE9ubHkgc3VwcG9ydCB0cmFuc2FjdGlvbnMgd2l0aCBvbmUgKHRyYW5zZmVyIHwgdm90ZXByb2R1Y2VyKSBvciB0d28gKGRlbGVnYXRlYncgJiB2b3RlcHJvZHVjZXIpIGFjdGlvbnNcbiAgICAgIGlmICh0eC5hY3Rpb25zLmxlbmd0aCAhPT0gMSAmJiB0eC5hY3Rpb25zLmxlbmd0aCAhPT0gMikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgbnVtYmVyIG9mIGFjdGlvbnM6ICR7dHguYWN0aW9ucy5sZW5ndGh9YCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHR4QWN0aW9uID0gdHguYWN0aW9uc1swXTtcbiAgICAgIGlmICghdHhBY3Rpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nIHRyYW5zYWN0aW9uIGFjdGlvbicpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHhBY3Rpb24ubmFtZSA9PT0gJ3RyYW5zZmVyJykge1xuICAgICAgICAvLyBUcmFuc2ZlcnMgc2hvdWxkIG9ubHkgaGF2ZSAxIGFjdGlvblxuICAgICAgICBpZiAodHguYWN0aW9ucy5sZW5ndGggIT09IDEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRyYW5zZmVycyBzaG91bGQgb25seSBoYXZlIDEgYWN0aW9uOiAke3R4LmFjdGlvbnMubGVuZ3RofSBnaXZlbmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdHJhbnNmZXJTdHJ1Y3QgPSBlb3NDbGllbnQuZmMuYWJpQ2FjaGUuYWJpKCdlb3Npby50b2tlbicpLnN0cnVjdHMudHJhbnNmZXI7XG4gICAgICAgIGNvbnN0IHNlcmlhbGl6ZWRUcmFuc2ZlckRhdGFCdWZmZXIgPSBCdWZmZXIuZnJvbSh0eEFjdGlvbi5kYXRhLCAnaGV4Jyk7XG4gICAgICAgIGNvbnN0IHRyYW5zZmVyQWN0aW9uRGF0YSA9IEVvc0pzLm1vZHVsZXMuRmNidWZmZXIuZnJvbUJ1ZmZlcih0cmFuc2ZlclN0cnVjdCwgc2VyaWFsaXplZFRyYW5zZmVyRGF0YUJ1ZmZlcik7XG4gICAgICAgIHR4LmFkZHJlc3MgPSB0cmFuc2ZlckFjdGlvbkRhdGEudG87XG4gICAgICAgIHR4LmFtb3VudCA9IHRoaXMuYmlnVW5pdHNUb0Jhc2VVbml0cyh0cmFuc2ZlckFjdGlvbkRhdGEucXVhbnRpdHkuc3BsaXQoJyAnKVswXSk7XG4gICAgICAgIHR4Lm1lbW8gPSB0cmFuc2ZlckFjdGlvbkRhdGEubWVtbztcbiAgICAgIH0gZWxzZSBpZiAodHhBY3Rpb24ubmFtZSA9PT0gJ2RlbGVnYXRlYncnKSB7XG4gICAgICAgIC8vIFRoZSBkZWxlZ2F0ZWJ3IGFjdGlvbiBzaG91bGQgb25seSBiZSBwYXJ0IG9mIHZvdGluZyB0cmFuc2FjdGlvbnNcbiAgICAgICAgaWYgKHR4LmFjdGlvbnMubGVuZ3RoICE9PSAyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYHN0YWtpbmcgdHJhbnNhY3Rpb25zIHRoYXQgaW5jbHVkZSB0aGUgZGVsZWdhdGVidyBhY3Rpb24gc2hvdWxkIGhhdmUgMiBhY3Rpb25zOiAke3R4LmFjdGlvbnMubGVuZ3RofSBnaXZlbmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdHhBY3Rpb24yID0gdHguYWN0aW9uc1sxXTtcbiAgICAgICAgaWYgKHR4QWN0aW9uMi5uYW1lICE9PSAndm90ZXByb2R1Y2VyJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBzdGFraW5nIHRyYW5zYWN0aW9uIGFjdGlvbjogJHt0eEFjdGlvbjIubmFtZX0sIGV4cGVjdGluZzogdm90ZXByb2R1Y2VyYCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbiA9IHNlbGYuZGVzZXJpYWxpemVTdGFrZUFjdGlvbihlb3NDbGllbnQsIHR4QWN0aW9uLmRhdGEpO1xuICAgICAgICBjb25zdCBkZXNlcmlhbGl6ZWRWb3RlQWN0aW9uID0gRW9zLmRlc2VyaWFsaXplVm90ZUFjdGlvbihlb3NDbGllbnQsIHR4QWN0aW9uMi5kYXRhKTtcbiAgICAgICAgaWYgKGRlc2VyaWFsaXplZFN0YWtlQWN0aW9uLmFkZHJlc3MgIT09IGRlc2VyaWFsaXplZFZvdGVBY3Rpb24uYWRkcmVzcykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBzdGFrZXIgKCR7ZGVzZXJpYWxpemVkU3Rha2VBY3Rpb24uYWRkcmVzc30pIGFuZCB2b3RlciAoJHtkZXNlcmlhbGl6ZWRWb3RlQWN0aW9uLmFkZHJlc3N9KSBtdXN0IGJlIHRoZSBzYW1lYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICB0eC5hbW91bnQgPSBkZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbi5hbW91bnQ7XG4gICAgICAgIHR4LnByb3h5ID0gZGVzZXJpYWxpemVkVm90ZUFjdGlvbi5wcm94eTtcbiAgICAgICAgdHgucHJvZHVjZXJzID0gZGVzZXJpYWxpemVkVm90ZUFjdGlvbi5wcm9kdWNlcnM7XG4gICAgICB9IGVsc2UgaWYgKHR4QWN0aW9uLm5hbWUgPT09ICd2b3RlcHJvZHVjZXInKSB7XG4gICAgICAgIGlmICh0eC5hY3Rpb25zLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZvdGluZyB0cmFuc2FjdGlvbnMgc2hvdWxkIG5vdCBoYXZlIG1vcmUgdGhhbiAyIGFjdGlvbnMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbjtcbiAgICAgICAgaWYgKHR4LmFjdGlvbnMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgY29uc3QgdHhBY3Rpb24yID0gdHguYWN0aW9uc1sxXTtcbiAgICAgICAgICBpZiAodHhBY3Rpb24yLm5hbWUgIT09ICdkZWxlZ2F0ZWJ3Jykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIHN0YWtpbmcgdHJhbnNhY3Rpb24gYWN0aW9uOiAke3R4QWN0aW9uMi5uYW1lfSwgZXhwZWN0aW5nOiBkZWxlZ2F0ZWJ3YCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGVzZXJpYWxpemVkU3Rha2VBY3Rpb24gPSBzZWxmLmRlc2VyaWFsaXplU3Rha2VBY3Rpb24oZW9zQ2xpZW50LCB0eEFjdGlvbjIuZGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZXNlcmlhbGl6ZWRWb3RlQWN0aW9uID0gRW9zLmRlc2VyaWFsaXplVm90ZUFjdGlvbihlb3NDbGllbnQsIHR4QWN0aW9uLmRhdGEpO1xuICAgICAgICBpZiAoISFkZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbiAmJiBkZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbi5hZGRyZXNzICE9PSBkZXNlcmlhbGl6ZWRWb3RlQWN0aW9uLmFkZHJlc3MpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgc3Rha2VyICgke2Rlc2VyaWFsaXplZFN0YWtlQWN0aW9uLmFkZHJlc3N9KSBhbmQgdm90ZXIgKCR7ZGVzZXJpYWxpemVkVm90ZUFjdGlvbi5hZGRyZXNzfSkgbXVzdCBiZSB0aGUgc2FtZWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgdHguYW1vdW50ID0gISFkZXNlcmlhbGl6ZWRTdGFrZUFjdGlvbiA/IGRlc2VyaWFsaXplZFN0YWtlQWN0aW9uLmFtb3VudCA6ICcwJztcbiAgICAgICAgdHgucHJveHkgPSBkZXNlcmlhbGl6ZWRWb3RlQWN0aW9uLnByb3h5O1xuICAgICAgICB0eC5wcm9kdWNlcnMgPSBkZXNlcmlhbGl6ZWRWb3RlQWN0aW9uLnByb2R1Y2VycztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBhY3Rpb246ICR7dHhBY3Rpb24ubmFtZX1gKTtcbiAgICAgIH1cbiAgICAgIC8vIEdldCB0aGUgdHggaWQgaWYgdHggaGVhZGVycyB3ZXJlIHByb3ZpZGVkXG4gICAgICBpZiAoaGVhZGVycykge1xuICAgICAgICBjb25zdCByZWJ1aWx0VHJhbnNhY3Rpb24gPSB5aWVsZCBlb3NDbGllbnQudHJhbnNhY3Rpb24oXG4gICAgICAgICAgeyBhY3Rpb25zOiB0eC5hY3Rpb25zIH0sXG4gICAgICAgICAgeyBzaWduOiBmYWxzZSwgYnJvYWRjYXN0OiBmYWxzZSB9XG4gICAgICAgICk7XG4gICAgICAgIHR4LnRyYW5zYWN0aW9uX2lkID0gcmVidWlsdFRyYW5zYWN0aW9uLnRyYW5zYWN0aW9uX2lkO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdHg7XG4gICAgfSkuY2FsbCh0aGlzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBsYWluL3BhcnNlIHRyYW5zYWN0aW9uXG4gICAqIEBwYXJhbSBwYXJhbXMgLSBFeHBsYWluVHJhbnNhY3Rpb25PcHRpb25zXG4gICAqIEBwYXJhbSBjYWxsYmFja1xuICAgKi9cbiAgZXhwbGFpblRyYW5zYWN0aW9uKFxuICAgIHBhcmFtczogRXhwbGFpblRyYW5zYWN0aW9uT3B0aW9ucyxcbiAgICBjYWxsYmFjaz86IE5vZGVDYWxsYmFjazxUcmFuc2FjdGlvbkV4cGxhbmF0aW9uPlxuICApOiBCbHVlYmlyZDxUcmFuc2FjdGlvbkV4cGxhbmF0aW9uPiB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIGNvPFRyYW5zYWN0aW9uRXhwbGFuYXRpb24+KGZ1bmN0aW9uKigpIHtcbiAgICAgIGxldCB0cmFuc2FjdGlvbjtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRyYW5zYWN0aW9uID0geWllbGQgc2VsZi5kZXNlcmlhbGl6ZVRyYW5zYWN0aW9uKHBhcmFtcyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBFT1MgdHJhbnNhY3Rpb24gb3IgaGVhZGVycycpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGlzcGxheU9yZGVyOiBbXG4gICAgICAgICAgJ2lkJyxcbiAgICAgICAgICAnb3V0cHV0QW1vdW50JyxcbiAgICAgICAgICAnY2hhbmdlQW1vdW50JyxcbiAgICAgICAgICAnb3V0cHV0cycsXG4gICAgICAgICAgJ2NoYW5nZU91dHB1dHMnLFxuICAgICAgICAgICdmZWUnLFxuICAgICAgICAgICdtZW1vJyxcbiAgICAgICAgICAncHJveHknLFxuICAgICAgICAgICdwcm9kdWNlcnMnLFxuICAgICAgICBdLFxuICAgICAgICBpZDogdHJhbnNhY3Rpb24udHJhbnNhY3Rpb25faWQsXG4gICAgICAgIGNoYW5nZU91dHB1dHM6IFtdLFxuICAgICAgICBvdXRwdXRBbW91bnQ6IHRyYW5zYWN0aW9uLmFtb3VudCxcbiAgICAgICAgY2hhbmdlQW1vdW50OiAwLFxuICAgICAgICBvdXRwdXRzOiAhIXRyYW5zYWN0aW9uLmFkZHJlc3MgPyBbeyBhZGRyZXNzOiB0cmFuc2FjdGlvbi5hZGRyZXNzLCBhbW91bnQ6IHRyYW5zYWN0aW9uLmFtb3VudCB9XSA6IFtdLFxuICAgICAgICBmZWU6IHt9LFxuICAgICAgICBtZW1vOiB0cmFuc2FjdGlvbi5tZW1vLFxuICAgICAgICBwcm94eTogdHJhbnNhY3Rpb24ucHJveHksXG4gICAgICAgIHByb2R1Y2VyczogdHJhbnNhY3Rpb24ucHJvZHVjZXJzLFxuICAgICAgfTtcbiAgICB9KVxuICAgICAgLmNhbGwodGhpcylcbiAgICAgIC5hc0NhbGxiYWNrKGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBhIHB1YmxpYyBvciBwcml2YXRlIGtleVxuICAgKiBJZiBwYXNzcGhyYXNlIGlzIHByb3ZpZGVkLCB0cnkgdG8gZGVjcnlwdCB0aGUga2V5IHdpdGggaXRcbiAgICogQHBhcmFtIGtleVxuICAgKiBAcGFyYW0gc291cmNlXG4gICAqIEBwYXJhbSBwYXNzcGhyYXNlXG4gICAqIEBwYXJhbSBpc1Vuc2lnbmVkU3dlZXBcbiAgICogQHBhcmFtIGlzS3JzUmVjb3ZlcnlcbiAgICovXG4gIHZhbGlkYXRlS2V5KHsga2V5LCBzb3VyY2UsIHBhc3NwaHJhc2UsIGlzVW5zaWduZWRTd2VlcCwgaXNLcnNSZWNvdmVyeSB9OiBWYWxpZGF0ZUtleU9wdGlvbnMpOiBIRE5vZGUge1xuICAgIGlmICgha2V5LnN0YXJ0c1dpdGgoJ3hwcnYnKSAmJiAhaXNVbnNpZ25lZFN3ZWVwKSB7XG4gICAgICAvLyBUcnkgdG8gZGVjcnlwdCB0aGUga2V5XG4gICAgICB0cnkge1xuICAgICAgICBpZiAoc291cmNlID09PSAndXNlcicgfHwgKHNvdXJjZSA9PT0gJ2JhY2t1cCcgJiYgIWlzS3JzUmVjb3ZlcnkpKSB7XG4gICAgICAgICAgcmV0dXJuIEhETm9kZS5mcm9tQmFzZTU4KHRoaXMuYml0Z28uZGVjcnlwdCh7IHBhc3N3b3JkOiBwYXNzcGhyYXNlLCBpbnB1dDoga2V5IH0pKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZWNyeXB0ICR7c291cmNlfSBrZXkgd2l0aCBwYXNzY29kZSAtIHRyeSBhZ2FpbiFgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBIRE5vZGUuZnJvbUJhc2U1OChrZXkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHZhbGlkYXRlICR7c291cmNlfSBrZXkgLSB0cnkgYWdhaW4hYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmUgYW5kIHZhbGlkYXRlIGFsbCBrZXljaGFpbnMgZnJvbSB0aGUga2V5Y2FyZCBmb3IgcmVjb3ZlcnlcbiAgICogQHBhcmFtIHVzZXJLZXlcbiAgICogQHBhcmFtIGJhY2t1cEtleVxuICAgKiBAcGFyYW0gcmVjb3ZlcnlEZXN0aW5hdGlvblxuICAgKiBAcGFyYW0ga3JzUHJvdmlkZXJcbiAgICogQHBhcmFtIHdhbGxldFBhc3NwaHJhc2VcbiAgICovXG4gIGluaXRpYXRlUmVjb3Zlcnkoe1xuICAgIHVzZXJLZXksXG4gICAgYmFja3VwS2V5LFxuICAgIHJlY292ZXJ5RGVzdGluYXRpb24sXG4gICAga3JzUHJvdmlkZXIsXG4gICAgd2FsbGV0UGFzc3BocmFzZSxcbiAgfTogUmVjb3ZlcnlPcHRpb25zKTogQmx1ZWJpcmQ8SEROb2RlW10+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gY288SEROb2RlW10+KGZ1bmN0aW9uKigpIHtcbiAgICAgIGNvbnN0IGlzS3JzUmVjb3ZlcnkgPSBiYWNrdXBLZXkuc3RhcnRzV2l0aCgneHB1YicpICYmICF1c2VyS2V5LnN0YXJ0c1dpdGgoJ3hwdWInKTtcbiAgICAgIGNvbnN0IGlzVW5zaWduZWRTd2VlcCA9IGJhY2t1cEtleS5zdGFydHNXaXRoKCd4cHViJykgJiYgdXNlcktleS5zdGFydHNXaXRoKCd4cHViJyk7XG5cbiAgICAgIGlmIChpc0tyc1JlY292ZXJ5KSB7XG4gICAgICAgIGlmICgha3JzUHJvdmlkZXIgfHwgXy5pc1VuZGVmaW5lZChjb25maWcua3JzUHJvdmlkZXJzW2tyc1Byb3ZpZGVyXSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vua25vd24ga2V5IHJlY292ZXJ5IHNlcnZpY2UgcHJvdmlkZXInKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBrcnNQcm92aWRlckNvbmZpZyA9IGNvbmZpZy5rcnNQcm92aWRlcnNba3JzUHJvdmlkZXJdO1xuICAgICAgICBpZiAoIWtyc1Byb3ZpZGVyQ29uZmlnLnN1cHBvcnRlZENvaW5zLmluY2x1ZGVzKHNlbGYuZ2V0RmFtaWx5KCkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzcGVjaWZpZWQga2V5IHJlY292ZXJ5IHNlcnZpY2UgZG9lcyBub3Qgc3VwcG9ydCByZWNvdmVyaWVzIGZvciB0aGlzIGNvaW4nKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBrZXlzID0gW1xuICAgICAgICBzZWxmLnZhbGlkYXRlS2V5KHtcbiAgICAgICAgICBrZXk6IHVzZXJLZXksXG4gICAgICAgICAgc291cmNlOiAndXNlcicsXG4gICAgICAgICAgcGFzc3BocmFzZTogd2FsbGV0UGFzc3BocmFzZSxcbiAgICAgICAgICBpc0tyc1JlY292ZXJ5LFxuICAgICAgICAgIGlzVW5zaWduZWRTd2VlcCxcbiAgICAgICAgfSksXG4gICAgICAgIHNlbGYudmFsaWRhdGVLZXkoe1xuICAgICAgICAgIGtleTogYmFja3VwS2V5LFxuICAgICAgICAgIHNvdXJjZTogJ2JhY2t1cCcsXG4gICAgICAgICAgcGFzc3BocmFzZTogd2FsbGV0UGFzc3BocmFzZSxcbiAgICAgICAgICBpc0tyc1JlY292ZXJ5LFxuICAgICAgICAgIGlzVW5zaWduZWRTd2VlcCxcbiAgICAgICAgfSksXG4gICAgICBdO1xuICAgICAgaWYgKCFzZWxmLmlzVmFsaWRBZGRyZXNzKHJlY292ZXJ5RGVzdGluYXRpb24pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkZXN0aW5hdGlvbiBhZGRyZXNzIScpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ga2V5cztcbiAgICB9KS5jYWxsKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ha2UgYSByZXF1ZXN0IHRvIG9uZSBvZiB0aGUgcHVibGljIEVPUyBub2RlcyBhdmFpbGFibGVcbiAgICogQHBhcmFtIGVuZHBvaW50XG4gICAqIEBwYXJhbSBwYXlsb2FkXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0RGF0YUZyb21Ob2RlKHsgZW5kcG9pbnQsIHBheWxvYWQgfTogeyBlbmRwb2ludDogc3RyaW5nOyBwYXlsb2FkPzogb2JqZWN0IH0pOiBCbHVlYmlyZDxhbnk+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gY28oZnVuY3Rpb24qKCkge1xuICAgICAgY29uc3Qgbm9kZVVybHMgPSBzZWxmLmdldFB1YmxpY05vZGVVcmxzKCk7XG4gICAgICBmb3IgKGNvbnN0IG5vZGVVcmwgb2Ygbm9kZVVybHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXR1cm4geWllbGQgcmVxdWVzdC5wb3N0KG5vZGVVcmwgKyBlbmRwb2ludCkuc2VuZChwYXlsb2FkKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIC8vIGxldCdzIGhvcGUgYW5vdGhlciBjYWxsIHN1Y2NlZWRzXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGNhbGwgZW5kcG9pbnQ6ICR7ZW5kcG9pbnR9IGZyb20gbm9kZXM6ICR7Xy5qb2luKG5vZGVVcmxzLCAnLCAnKX1gKTtcbiAgICB9KS5jYWxsKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBFT1MgY2hhaW4gaW5mbyBmcm9tIGEgcHVibGljIG5vZGVcbiAgICovXG4gIHByb3RlY3RlZCBnZXRDaGFpbkluZm9Gcm9tTm9kZSgpOiBCbHVlYmlyZDxhbnk+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gY28oZnVuY3Rpb24qKCkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSB5aWVsZCBzZWxmLmdldERhdGFGcm9tTm9kZSh7IGVuZHBvaW50OiAnL3YxL2NoYWluL2dldF9pbmZvJyB9KTtcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBmZXRjaCBjaGFpbiBpbmZvJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzcG9uc2UuYm9keTtcbiAgICB9KS5jYWxsKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkYXRhIHNwZWNpZmljIHRvIGFuIGFjY291bnQgZnJvbSBhIHB1YmxpYyBub2RlXG4gICAqIEBwYXJhbSBhZGRyZXNzXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0QWNjb3VudEZyb21Ob2RlKHsgYWRkcmVzcyB9OiB7IGFkZHJlc3M6IHN0cmluZyB9KTogQmx1ZWJpcmQ8YW55PiB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIGNvKGZ1bmN0aW9uKigpIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0geWllbGQgc2VsZi5nZXREYXRhRnJvbU5vZGUoe1xuICAgICAgICBlbmRwb2ludDogJy92MS9jaGFpbi9nZXRfYWNjb3VudCcsXG4gICAgICAgIHBheWxvYWQ6IHsgYWNjb3VudF9uYW1lOiBhZGRyZXNzIH0sXG4gICAgICB9KTtcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FjY291bnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzcG9uc2UuYm9keTtcbiAgICB9KS5jYWxsKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBibG9jayBkYXRhIGZyb20gYSBwdWJsaWMgbm9kZSB1c2luZyBpdHMgYmxvY2sgbnVtYmVyIG9yIGJsb2NrIGlkXG4gICAqIEBwYXJhbSBibG9ja051bU9ySWRcbiAgICovXG4gIHByb3RlY3RlZCBnZXRCbG9ja0Zyb21Ob2RlKHsgYmxvY2tOdW1PcklkIH06IHsgYmxvY2tOdW1PcklkOiBzdHJpbmcgfSk6IEJsdWViaXJkPGFueT4ge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiooKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIHNlbGYuZ2V0RGF0YUZyb21Ob2RlKHtcbiAgICAgICAgZW5kcG9pbnQ6ICcvdjEvY2hhaW4vZ2V0X2Jsb2NrJyxcbiAgICAgICAgcGF5bG9hZDogeyBibG9ja19udW1fb3JfaWQ6IGJsb2NrTnVtT3JJZCB9LFxuICAgICAgfSk7XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCbG9jayBub3QgZm91bmQnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNwb25zZS5ib2R5O1xuICAgIH0pLmNhbGwodGhpcyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGhlYWRlcnMgZm9yIGFuIEVPUyB0eCBmcm9tIGEgcHVibGljIG5vZGVcbiAgICovXG4gIHByb3RlY3RlZCBnZXRUcmFuc2FjdGlvbkhlYWRlcnNGcm9tTm9kZSgpOiBCbHVlYmlyZDxhbnk+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gY28oZnVuY3Rpb24qKCkge1xuICAgICAgY29uc3QgY2hhaW5JbmZvID0geWllbGQgc2VsZi5nZXRDaGFpbkluZm9Gcm9tTm9kZSgpO1xuICAgICAgY29uc3QgaGVhZEJsb2NrSW5mb1Jlc3VsdCA9IHlpZWxkIHNlbGYuZ2V0QmxvY2tGcm9tTm9kZSh7IGJsb2NrTnVtT3JJZDogY2hhaW5JbmZvLmhlYWRfYmxvY2tfbnVtIH0pO1xuICAgICAgY29uc3QgZXhwaXJlU2Vjb25kcyA9IDI4ODAwOyAvLyBtYXhpbXVtIHR4IGV4cGlyZSB0aW1lIG9mIDhoXG4gICAgICBjb25zdCBjaGFpbkRhdGUgPSBuZXcgRGF0ZShjaGFpbkluZm8uaGVhZF9ibG9ja190aW1lICsgJ1onKTtcbiAgICAgIGNvbnN0IGV4cGlyYXRpb25EYXRlID0gbmV3IERhdGUoY2hhaW5EYXRlLmdldFRpbWUoKSArIGV4cGlyZVNlY29uZHMgKiAxMDAwKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZXhwaXJhdGlvbjogZXhwaXJhdGlvbkRhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgICAgcmVmX2Jsb2NrX251bTogY2hhaW5JbmZvLmhlYWRfYmxvY2tfbnVtICYgMHhmZmZmLFxuICAgICAgICByZWZfYmxvY2tfcHJlZml4OiBoZWFkQmxvY2tJbmZvUmVzdWx0LnJlZl9ibG9ja19wcmVmaXgsXG4gICAgICB9O1xuICAgIH0pLmNhbGwodGhpcyk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0VHJhbnNmZXJBY3Rpb24oeyByZWNpcGllbnQsIHNlbmRlciwgYW1vdW50LCBtZW1vIH0pOiBFb3NUcmFuc2FjdGlvbkFjdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFjY291bnQ6ICdlb3Npby50b2tlbicsXG4gICAgICBuYW1lOiAndHJhbnNmZXInLFxuICAgICAgYXV0aG9yaXphdGlvbjogW1xuICAgICAgICB7XG4gICAgICAgICAgYWN0b3I6IHNlbmRlcixcbiAgICAgICAgICBwZXJtaXNzaW9uOiAnYWN0aXZlJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGZyb206IHNlbmRlcixcbiAgICAgICAgdG86IHJlY2lwaWVudCxcbiAgICAgICAgcXVhbnRpdHk6IGAke3RoaXMuYmFzZVVuaXRzVG9CaWdVbml0cyhhbW91bnQpfSBFT1NgLFxuICAgICAgICBtZW1vOiAhXy5pc05pbChtZW1vKSA/IG1lbW8gOiAnJywgLy8gTWVtbyBtdXN0IGJlIGRlZmluZWQsIHNldCBpdCB0byBlbXB0eSBzdHJpbmcgaWYgaXQgaXMgbm90XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2lnbiBhIHRyYW5zYWN0aW9uIHdpdGggYSBrZXlcbiAgICogQHBhcmFtIHNpZ25hYmxlVHhcbiAgICogQHBhcmFtIHNpZ25pbmdLZXlcbiAgICovXG4gIHNpZ25UeChzaWduYWJsZVR4OiBzdHJpbmcsIHNpZ25pbmdLZXk6IEhETm9kZSk6IHN0cmluZyB7XG4gICAgY29uc3Qgc2lnbkJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHNpZ25hYmxlVHgsICdoZXgnKTtcbiAgICBjb25zdCBwcml2YXRlS2V5QnVmZmVyID0gc2lnbmluZ0tleS5nZXRLZXkoKS5nZXRQcml2YXRlS2V5QnVmZmVyKCk7XG4gICAgcmV0dXJuIGVjYy5TaWduYXR1cmUuc2lnbihzaWduQnVmZmVyLCBwcml2YXRlS2V5QnVmZmVyKS50b1N0cmluZygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlcmlhbGl6ZSBhbiBFT1MgdHJhbnNhY3Rpb24sIHRvIHRoZSBmb3JtYXQgdGhhdCBzaG91bGQgYmUgc2lnbmVkXG4gICAqIEBwYXJhbSBlb3NDbGllbnQgYW4gb2ZmbGluZSBFT1NDbGllbnQgdGhhdCBoYXMgdGhlIHRyYW5zYWN0aW9uIHN0cnVjdHNcbiAgICogQHBhcmFtIHRyYW5zYWN0aW9uIFRoZSBFT1MgdHJhbnNhY3Rpb24gcmV0dXJuZWQgZnJvbSBgZW9zQ2xpZW50LnRyYW5zYWN0aW9uYCB0byBzZXJpYWxpemVcbiAgICogQHJldHVybiB7U3RyaW5nfSBzZXJpYWxpemVkIHRyYW5zYWN0aW9uIGluIGhleCBmb3JtYXRcbiAgICovXG4gIHNlcmlhbGl6ZVRyYW5zYWN0aW9uKGVvc0NsaWVudDogRW9zSnMsIHRyYW5zYWN0aW9uOiBFb3NKcy50cmFuc2FjdGlvbik6IHN0cmluZyB7XG4gICAgY29uc3QgZW9zVHhTdHJ1Y3QgPSBlb3NDbGllbnQuZmMuc3RydWN0cy50cmFuc2FjdGlvbjtcbiAgICBjb25zdCB0eEhleCA9IHRyYW5zYWN0aW9uLnRyYW5zYWN0aW9uLnRyYW5zYWN0aW9uO1xuICAgIGNvbnN0IHR4T2JqZWN0ID0gZW9zVHhTdHJ1Y3QuZnJvbU9iamVjdCh0eEhleCk7XG5cbiAgICByZXR1cm4gRW9zSnMubW9kdWxlcy5GY2J1ZmZlci50b0J1ZmZlcihlb3NUeFN0cnVjdCwgdHhPYmplY3QpLnRvU3RyaW5nKCdoZXgnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsZHMgYSBmdW5kcyByZWNvdmVyeSB0cmFuc2FjdGlvbiB3aXRob3V0IEJpdEdvXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHBhcmFtIGNhbGxiYWNrXG4gICAqL1xuICByZWNvdmVyKHBhcmFtczogUmVjb3ZlcnlPcHRpb25zLCBjYWxsYmFjaz86IE5vZGVDYWxsYmFjazxSZWNvdmVyeVRyYW5zYWN0aW9uPik6IEJsdWViaXJkPFJlY292ZXJ5VHJhbnNhY3Rpb24+IHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gY288UmVjb3ZlcnlUcmFuc2FjdGlvbj4oZnVuY3Rpb24qKCkge1xuICAgICAgaWYgKCFwYXJhbXMucm9vdEFkZHJlc3MpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nIHJlcXVpcmVkIHN0cmluZyByb290QWRkcmVzcycpO1xuICAgICAgfVxuICAgICAgY29uc3QgaXNLcnNSZWNvdmVyeSA9IHBhcmFtcy5iYWNrdXBLZXkuc3RhcnRzV2l0aCgneHB1YicpICYmICFwYXJhbXMudXNlcktleS5zdGFydHNXaXRoKCd4cHViJyk7XG4gICAgICBjb25zdCBpc1Vuc2lnbmVkU3dlZXAgPSBwYXJhbXMuYmFja3VwS2V5LnN0YXJ0c1dpdGgoJ3hwdWInKSAmJiBwYXJhbXMudXNlcktleS5zdGFydHNXaXRoKCd4cHViJyk7XG5cbiAgICAgIGNvbnN0IGtleXMgPSB5aWVsZCBzZWxmLmluaXRpYXRlUmVjb3ZlcnkocGFyYW1zKTtcblxuICAgICAgY29uc3QgYWNjb3VudCA9IHlpZWxkIHNlbGYuZ2V0QWNjb3VudEZyb21Ob2RlKHsgYWRkcmVzczogcGFyYW1zLnJvb3RBZGRyZXNzIH0pO1xuXG4gICAgICBjb25zdCB1c2VyUHViID0gZWNjLlB1YmxpY0tleS5mcm9tQnVmZmVyKGtleXNbMF0uZ2V0UHVibGljS2V5QnVmZmVyKCkpLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCBiYWNrdXBQdWIgPSBlY2MuUHVibGljS2V5LmZyb21CdWZmZXIoa2V5c1sxXS5nZXRQdWJsaWNLZXlCdWZmZXIoKSkudG9TdHJpbmcoKTtcblxuICAgICAgY29uc3QgYWN0aXZlUGVybWlzc2lvbiA9IF8uZmluZChhY2NvdW50LnBlcm1pc3Npb25zLCB7IHBlcm1fbmFtZTogJ2FjdGl2ZScgfSk7XG4gICAgICBjb25zdCByZXF1aXJlZEF1dGggPSBfLmdldChhY3RpdmVQZXJtaXNzaW9uLCAncmVxdWlyZWRfYXV0aCcpO1xuICAgICAgaWYgKCFyZXF1aXJlZEF1dGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1aXJlZCBhdXRoIGZvciBhY3RpdmUgcGVybWlzc2lvbiBub3QgZm91bmQgaW4gYWNjb3VudCcpO1xuICAgICAgfVxuICAgICAgaWYgKHJlcXVpcmVkQXV0aC50aHJlc2hvbGQgIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIGFjdGl2ZSBwZXJtaXNzaW9uIHRocmVzaG9sZCcpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmb3VuZFB1YnMgPSB7fTtcbiAgICAgIGNvbnN0IHJlcXVpcmVkQXV0aEtleXMgPSByZXF1aXJlZEF1dGgua2V5cztcbiAgICAgIGZvciAoY29uc3Qgc2lnbmVyIG9mIHJlcXVpcmVkQXV0aEtleXMpIHtcbiAgICAgICAgaWYgKHNpZ25lci53ZWlnaHQgIT09IDEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgc2lnbmVyIHdlaWdodCcpO1xuICAgICAgICB9XG4gICAgICAgIC8vIGlmIGl0J3MgYSBkdXBlIG9mIGEgcHViIHdlIGFscmVhZHkga25vdywgYmxvY2tcbiAgICAgICAgaWYgKGZvdW5kUHVic1tzaWduZXIua2V5XSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZHVwbGljYXRlIHNpZ25lciBrZXknKTtcbiAgICAgICAgfVxuICAgICAgICBmb3VuZFB1YnNbc2lnbmVyLmtleV0gPSAoZm91bmRQdWJzW3NpZ25lci5rZXldIHx8IDApICsgMTtcbiAgICAgIH1cbiAgICAgIGlmIChmb3VuZFB1YnNbdXNlclB1Yl0gIT09IDEgfHwgZm91bmRQdWJzW2JhY2t1cFB1Yl0gIT09IDEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd1bmV4cGVjdGVkIGluY2lkZW5jZSBmcmVxdWVuY3kgb2YgdXNlciBzaWduZXIga2V5Jyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFjY291bnRCYWxhbmNlID0gYWNjb3VudC5jb3JlX2xpcXVpZF9iYWxhbmNlLnNwbGl0KCcgJylbMF07XG4gICAgICBjb25zdCByZWNvdmVyeUFtb3VudCA9IHRoaXMuYmlnVW5pdHNUb0Jhc2VVbml0cyhuZXcgQmlnTnVtYmVyKGFjY291bnRCYWxhbmNlKSk7XG5cbiAgICAgIGNvbnN0IGRlc3RpbmF0aW9uQWRkcmVzcyA9IHBhcmFtcy5yZWNvdmVyeURlc3RpbmF0aW9uO1xuICAgICAgY29uc3QgZGVzdGluYXRpb25BZGRyZXNzRGV0YWlscyA9IHNlbGYuZ2V0QWRkcmVzc0RldGFpbHMoZGVzdGluYXRpb25BZGRyZXNzKTtcbiAgICAgIGNvbnN0IGRlc3RpbmF0aW9uQWNjb3VudCA9IHlpZWxkIHNlbGYuZ2V0QWNjb3VudEZyb21Ob2RlKHsgYWRkcmVzczogZGVzdGluYXRpb25BZGRyZXNzIH0pO1xuICAgICAgaWYgKCFkZXN0aW5hdGlvbkFjY291bnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEZXN0aW5hdGlvbiBhY2NvdW50IG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0cmFuc2FjdGlvbkhlYWRlcnMgPSB5aWVsZCBzZWxmLmdldFRyYW5zYWN0aW9uSGVhZGVyc0Zyb21Ob2RlKCk7XG4gICAgICBjb25zdCBlb3NDbGllbnQgPSBuZXcgRW9zSnMoeyBjaGFpbklkOiBzZWxmLmdldENoYWluSWQoKSwgdHJhbnNhY3Rpb25IZWFkZXJzIH0pO1xuXG4gICAgICBjb25zdCB0cmFuc2ZlckFjdGlvbiA9IHNlbGYuZ2V0VHJhbnNmZXJBY3Rpb24oe1xuICAgICAgICByZWNpcGllbnQ6IGRlc3RpbmF0aW9uQWRkcmVzc0RldGFpbHMuYWRkcmVzcyxcbiAgICAgICAgc2VuZGVyOiBwYXJhbXMucm9vdEFkZHJlc3MsXG4gICAgICAgIGFtb3VudDogbmV3IEJpZ051bWJlcihyZWNvdmVyeUFtb3VudCksXG4gICAgICAgIG1lbW86IGRlc3RpbmF0aW9uQWRkcmVzc0RldGFpbHMubWVtb0lkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0geWllbGQgZW9zQ2xpZW50LnRyYW5zYWN0aW9uKHsgYWN0aW9uczogW3RyYW5zZmVyQWN0aW9uXSB9LCB7IHNpZ246IGZhbHNlLCBicm9hZGNhc3Q6IGZhbHNlIH0pO1xuXG4gICAgICBjb25zdCBzZXJpYWxpemVkVHJhbnNhY3Rpb24gPSBzZWxmLnNlcmlhbGl6ZVRyYW5zYWN0aW9uKGVvc0NsaWVudCwgdHJhbnNhY3Rpb24pO1xuICAgICAgY29uc3QgdHhPYmplY3QgPSB7XG4gICAgICAgIHRyYW5zYWN0aW9uOiB7XG4gICAgICAgICAgY29tcHJlc3Npb246ICdub25lJyxcbiAgICAgICAgICBwYWNrZWRfdHJ4OiBzZXJpYWxpemVkVHJhbnNhY3Rpb24sXG4gICAgICAgICAgc2lnbmF0dXJlczogW10gYXMgc3RyaW5nW10sXG4gICAgICAgIH0sXG4gICAgICAgIHR4aWQ6IHRyYW5zYWN0aW9uLnRyYW5zYWN0aW9uX2lkLFxuICAgICAgICByZWNvdmVyeUFtb3VudDogYWNjb3VudEJhbGFuY2UsXG4gICAgICB9O1xuICAgICAgY29uc3Qgc2lnbmFibGVUeCA9IEJ1ZmZlci5jb25jYXQoW1xuICAgICAgICBCdWZmZXIuZnJvbShzZWxmLmdldENoYWluSWQoKSwgJ2hleCcpLCAvLyBUaGUgQ2hhaW5JRCByZXByZXNlbnRpbmcgdGhlIGNoYWluIHRoYXQgd2UgYXJlIG9uXG4gICAgICAgIEJ1ZmZlci5mcm9tKHNlcmlhbGl6ZWRUcmFuc2FjdGlvbiwgJ2hleCcpLCAvLyBUaGUgc2VyaWFsaXplZCB1bnNpZ25lZCB0eFxuICAgICAgICBCdWZmZXIuZnJvbShuZXcgVWludDhBcnJheSgzMikpLCAvLyBTb21lIHBhZGRpbmdcbiAgICAgIF0pLnRvU3RyaW5nKCdoZXgnKTtcblxuICAgICAgaWYgKGlzVW5zaWduZWRTd2VlcCkge1xuICAgICAgICByZXR1cm4gdHhPYmplY3Q7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVzZXJTaWduYXR1cmUgPSBzZWxmLnNpZ25UeChzaWduYWJsZVR4LCBrZXlzWzBdKTtcbiAgICAgIHR4T2JqZWN0LnRyYW5zYWN0aW9uLnNpZ25hdHVyZXMucHVzaCh1c2VyU2lnbmF0dXJlKTtcblxuICAgICAgaWYgKCFpc0tyc1JlY292ZXJ5KSB7XG4gICAgICAgIGNvbnN0IGJhY2t1cFNpZ25hdHVyZSA9IHNlbGYuc2lnblR4KHNpZ25hYmxlVHgsIGtleXNbMV0pO1xuICAgICAgICB0eE9iamVjdC50cmFuc2FjdGlvbi5zaWduYXR1cmVzLnB1c2goYmFja3VwU2lnbmF0dXJlKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHR4T2JqZWN0O1xuICAgIH0pXG4gICAgICAuY2FsbCh0aGlzKVxuICAgICAgLmFzQ2FsbGJhY2soY2FsbGJhY2spO1xuICB9XG5cbiAgcGFyc2VUcmFuc2FjdGlvbihcbiAgICBwYXJhbXM6IFBhcnNlVHJhbnNhY3Rpb25PcHRpb25zLFxuICAgIGNhbGxiYWNrPzogTm9kZUNhbGxiYWNrPFBhcnNlZFRyYW5zYWN0aW9uPlxuICApOiBCbHVlYmlyZDxQYXJzZWRUcmFuc2FjdGlvbj4ge1xuICAgIHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKHt9KS5hc0NhbGxiYWNrKGNhbGxiYWNrKTtcbiAgfVxuXG4gIHZlcmlmeVRyYW5zYWN0aW9uKHBhcmFtczogVmVyaWZ5VHJhbnNhY3Rpb25PcHRpb25zLCBjYWxsYmFjaz86IE5vZGVDYWxsYmFjazxib29sZWFuPik6IEJsdWViaXJkPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSh0cnVlKS5hc0NhbGxiYWNrKGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIHJhbmRvbSBFT1MgYWRkcmVzcy5cbiAgICpcbiAgICogVGhpcyBpcyBqdXN0IGEgcmFuZG9tIHN0cmluZyB3aGljaCBhYmlkZXMgYnkgdGhlIEVPUyBhZGRkcmVzcyBjb25zdHJhaW50cyxcbiAgICogYW5kIGlzIG5vdCBhY3R1YWxseSBjaGVja2VkIGZvciBhdmFpbGFiaWxpdHkgb24gdGhlIEVPUyBibG9ja2NoYWluLlxuICAgKlxuICAgKiBDdXJyZW50IEVPUyBhZGRyZXNzIGNvbnN0cmFpbnRzIGFyZTpcbiAgICogKiBBZGRyZXNzIG11c3QgYmUgZXhhY3RseSAxMiBjaGFyYWN0ZXJzXG4gICAqICogQWRkcmVzcyBtdXN0IG9ubHkgY29udGFpbiBsb3dlcmNhc2UgbGV0dGVycyBhbmQgbnVtYmVycyAxLTVcbiAgICogQHJldHVybnMgYSB2YWxpZGx5IGZvcm1hdHRlZCBFT1MgYWRkcmVzcywgd2hpY2ggbWF5IG9yIG1heSBub3QgYWN0dWFsbHkgYmUgYXZhaWxhYmxlIG9uIGNoYWluLlxuICAgKi9cbiAgZ2VuZXJhdGVSYW5kb21BZGRyZXNzKHBhcmFtczoge30pOiBzdHJpbmcge1xuICAgIGNvbnN0IGFkZHJlc3M6IHN0cmluZ1tdID0gW107XG4gICAgd2hpbGUgKGFkZHJlc3MubGVuZ3RoIDwgMTIpIHtcbiAgICAgIGNvbnN0IGNoYXIgPSBfLnNhbXBsZShFb3MuVkFMSURfQUREUkVTU19DSEFSUyk7XG4gICAgICBpZiAoIWNoYXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gc2FtcGxlIHZhbGlkIEVPUyBhZGRyZXNzIGNoYXJhY3RlcnMnKTtcbiAgICAgIH1cbiAgICAgIGFkZHJlc3MucHVzaChjaGFyKTtcbiAgICB9XG4gICAgcmV0dXJuIGFkZHJlc3Muam9pbignJyk7XG4gIH1cbn1cbiJdfQ==