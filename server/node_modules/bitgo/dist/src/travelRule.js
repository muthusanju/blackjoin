"use strict";
/**
 * @hidden
 */
Object.defineProperty(exports, "__esModule", { value: true });
/**
 */
//
// TravelRule Object
// BitGo accessor for a specific enterprise
//
// Copyright 2014, BitGo, Inc.  All Rights Reserved.
//
var bitcoin = require("bitgo-utxo-lib");
var common = require("./common");
var _ = require("lodash");
var bitcoin_1 = require("./bitcoin");
//
// Constructor
//
var TravelRule = function (bitgo) {
    this.bitgo = bitgo;
};
TravelRule.prototype.url = function (extra) {
    extra = extra || '';
    return this.bitgo.url('/travel/' + extra);
};
/**
  * Get available travel-rule info recipients for a transaction
  * @param params
  *  txid: transaction id
  * @param callback
  * @returns {*}
  */
TravelRule.prototype.getRecipients = function (params, callback) {
    params = params || {};
    params.txid = params.txid || params.hash;
    common.validateParams(params, ['txid'], [], callback);
    var url = this.url(params.txid + '/recipients');
    return this.bitgo.get(url)
        .result('recipients')
        .nodeify(callback);
};
TravelRule.prototype.validateTravelInfo = function (info) {
    var fields = {
        amount: { type: 'number' },
        toAddress: { type: 'string' },
        toEnterprise: { type: 'string' },
        fromUserName: { type: 'string' },
        fromUserAccount: { type: 'string' },
        fromUserAddress: { type: 'string' },
        toUserName: { type: 'string' },
        toUserAccount: { type: 'string' },
        toUserAddress: { type: 'string' },
        extra: { type: 'object' }
    };
    _.forEach(fields, function (field, fieldName) {
        // No required fields yet -- should there be?
        if (field.required) {
            if (info[fieldName] === undefined) {
                throw new Error('missing required field ' + fieldName + ' in travel info');
            }
        }
        if (info[fieldName] && typeof (info[fieldName]) !== field.type) {
            throw new Error('incorrect type for field ' + fieldName + ' in travel info, expected ' + field.type);
        }
    });
    // Strip out any other fields we don't know about
    var result = _.pick(info, _.keys(fields));
    if (_.isEmpty(result)) {
        throw new Error('empty travel data');
    }
    return result;
};
/**
 * Takes a transaction object as returned by getTransaction or listTransactions, along
 * with a keychain (or hdnode object), and attempts to decrypt any encrypted travel
 * info included in the transaction's receivedTravelInfo field.
 * Parameters:
 *   tx: a transaction object
 *   keychain: keychain object (with xprv)
 *   hdnode: a bitcoin.HDNode object (may be provided instead of keychain)
 * Returns:
 *   the tx object, augmented with decrypted travelInfo fields
 */
TravelRule.prototype.decryptReceivedTravelInfo = function (params) {
    if (params === void 0) { params = {}; }
    var tx = params.tx;
    if (!_.isObject(tx)) {
        throw new Error('expecting tx param to be object');
    }
    if (!tx.receivedTravelInfo || !tx.receivedTravelInfo.length) {
        return tx;
    }
    var hdNode;
    // Passing in hdnode is faster because it doesn't reconstruct the key every time
    if (params.hdnode) {
        hdNode = params.hdnode;
    }
    else {
        var keychain = params.keychain;
        if (!_.isObject(keychain) || !_.isString(keychain.xprv)) {
            throw new Error('expecting keychain param with xprv');
        }
        hdNode = bitcoin.HDNode.fromBase58(keychain.xprv);
    }
    var self = this;
    var hdPathNode = bitcoin_1.hdPath(hdNode);
    tx.receivedTravelInfo.forEach(function (info) {
        var key = hdPathNode.deriveKey(info.toPubKeyPath);
        var secret = self.bitgo.getECDHSecret({
            eckey: key,
            otherPubKeyHex: info.fromPubKey
        });
        try {
            var decrypted = this.bitgo.decrypt({
                input: info.encryptedTravelInfo,
                password: secret
            });
            info.travelInfo = JSON.parse(decrypted);
        }
        catch (err) {
            console.error('failed to decrypt or parse travel info for ', info.transactionId + ':' + info.outputIndex);
        }
    });
    return tx;
};
TravelRule.prototype.prepareParams = function (params) {
    params = params || {};
    params.txid = params.txid || params.hash;
    common.validateParams(params, ['txid'], ['fromPrivateInfo']);
    var txid = params.txid;
    var recipient = params.recipient;
    var travelInfo = params.travelInfo;
    if (!recipient || !_.isObject(recipient)) {
        throw new Error('invalid or missing recipient');
    }
    if (!travelInfo || !_.isObject(travelInfo)) {
        throw new Error('invalid or missing travelInfo');
    }
    if (!params.noValidate) {
        travelInfo = this.validateTravelInfo(travelInfo);
    }
    // Fill in toEnterprise if not already filled
    if (!travelInfo.toEnterprise && recipient.enterprise) {
        travelInfo.toEnterprise = recipient.enterprise;
    }
    // If a key was not provided, create a new random key
    var fromKey = params.fromKey && bitcoin.ECPair.fromWIF(params.fromKey, bitcoin_1.getNetwork());
    if (!fromKey) {
        fromKey = bitcoin_1.makeRandomKey();
    }
    // Compute the shared key for encryption
    var sharedSecret = this.bitgo.getECDHSecret({
        eckey: fromKey,
        otherPubKeyHex: recipient.pubKey
    });
    // JSON-ify and encrypt the payload
    var travelInfoJSON = JSON.stringify(travelInfo);
    var encryptedTravelInfo = this.bitgo.encrypt({
        input: travelInfoJSON,
        password: sharedSecret
    });
    var result = {
        txid: txid,
        outputIndex: recipient.outputIndex,
        toPubKey: recipient.pubKey,
        fromPubKey: fromKey.getPublicKeyBuffer().toString('hex'),
        encryptedTravelInfo: encryptedTravelInfo,
        fromPrivateInfo: undefined
    };
    if (params.fromPrivateInfo) {
        result.fromPrivateInfo = params.fromPrivateInfo;
    }
    return result;
};
/**
 * Send travel data to the server for a transaction
 */
TravelRule.prototype.send = function (params, callback) {
    params = params || {};
    params.txid = params.txid || params.hash;
    common.validateParams(params, ['txid', 'toPubKey', 'encryptedTravelInfo'], ['fromPubKey', 'fromPrivateInfo'], callback);
    if (!_.isNumber(params.outputIndex)) {
        throw new Error('invalid outputIndex');
    }
    return this.bitgo.post(this.url(params.txid + '/' + params.outputIndex))
        .send(params)
        .result()
        .nodeify(callback);
};
/**
 * Send multiple travel rule infos for the outputs of a single transaction.
 * Parameters:
 *   - txid (or hash): txid of the transaction (must be a sender of the tx)
 *   - travelInfos: array of travelInfo objects which look like the following:
 *     {
 *       outputIndex: number,     // tx output index
 *       fromUserName: string,    // name of the sending user
 *       fromUserAccount: string, // account id of the sending user
 *       fromUserAddress: string, // mailing address of the sending user
 *       toUserName: string,      // name of the receiving user
 *       toUserAccount: string,   // account id of the receiving user
 *       toUserAddress: string    // mailing address of the receiving user
 *     }
 *     All fields aside from outputIndex are optional, but at least one must
 *     be defined.
 *
 *  It is not necessary to provide travelInfo for all output indices.
 *  End-to-end encryption of the travel info is handled automatically by this method.
 *
 */
TravelRule.prototype.sendMany = function (params, callback) {
    params = params || {};
    params.txid = params.txid || params.hash;
    common.validateParams(params, ['txid'], callback);
    var travelInfos = params.travelInfos;
    if (!_.isArray(travelInfos)) {
        throw new Error('expected parameter travelInfos to be array');
    }
    var self = this;
    var travelInfoMap = _(travelInfos)
        .keyBy('outputIndex')
        .mapValues(function (travelInfo) {
        return self.validateTravelInfo(travelInfo);
    })
        .value();
    return self.getRecipients({ txid: params.txid })
        .then(function (recipients) {
        // Build up data to post
        var sendParamsList = [];
        // don't regenerate a new random key for each recipient
        var fromKey = params.fromKey || bitcoin_1.makeRandomKey().toWIF();
        recipients.forEach(function (recipient) {
            var outputIndex = recipient.outputIndex;
            var info = travelInfoMap[outputIndex];
            if (info) {
                if (info.amount && info.amount !== recipient.amount) {
                    throw new Error('amount did not match for output index ' + outputIndex);
                }
                var sendParams = self.prepareParams({
                    txid: params.txid,
                    recipient: recipient,
                    travelInfo: info,
                    fromKey: fromKey,
                    noValidate: true // don't re-validate
                });
                sendParamsList.push(sendParams);
            }
        });
        var result = {
            matched: sendParamsList.length,
            results: []
        };
        var sendSerial = function () {
            var sendParams = sendParamsList.shift();
            if (!sendParams) {
                return result;
            }
            return self.send(sendParams)
                .then(function (res) {
                result.results.push({ result: res });
                return sendSerial();
            })
                .catch(function (err) {
                result.results.push({ error: err.toString() });
                return sendSerial();
            });
        };
        return sendSerial();
    });
};
module.exports = TravelRule;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVsUnVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmF2ZWxSdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSDtHQUNHO0FBQ0gsRUFBRTtBQUNGLG9CQUFvQjtBQUNwQiwyQ0FBMkM7QUFDM0MsRUFBRTtBQUNGLG9EQUFvRDtBQUNwRCxFQUFFO0FBRUYsd0NBQTBDO0FBQzFDLGlDQUFtQztBQUNuQywwQkFBNEI7QUFDNUIscUNBQThEO0FBeUI5RCxFQUFFO0FBQ0YsY0FBYztBQUNkLEVBQUU7QUFDRixJQUFNLFVBQVUsR0FBRyxVQUFTLEtBQUs7SUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7QUFDckIsQ0FBQyxDQUFDO0FBRUYsVUFBVSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsVUFBUyxLQUFLO0lBQ3ZDLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO0lBQ3BCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQzVDLENBQUMsQ0FBQztBQUdGOzs7Ozs7SUFNSTtBQUNKLFVBQVUsQ0FBQyxTQUFTLENBQUMsYUFBYSxHQUFHLFVBQVMsTUFBTSxFQUFFLFFBQVE7SUFDNUQsTUFBTSxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7SUFDdEIsTUFBTSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDekMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFdEQsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQyxDQUFDO0lBQ2xELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1NBQ3pCLE1BQU0sQ0FBQyxZQUFZLENBQUM7U0FDcEIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3JCLENBQUMsQ0FBQztBQUVGLFVBQVUsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLEdBQUcsVUFBUyxJQUFJO0lBQ3JELElBQU0sTUFBTSxHQUFHO1FBQ2IsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtRQUMxQixTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO1FBQzdCLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7UUFDaEMsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtRQUNoQyxlQUFlLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO1FBQ25DLGVBQWUsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7UUFDbkMsVUFBVSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtRQUM5QixhQUFhLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO1FBQ2pDLGFBQWEsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7UUFDakMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtLQUMxQixDQUFDO0lBRUYsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsVUFBUyxLQUFVLEVBQUUsU0FBUztRQUM5Qyw2Q0FBNkM7UUFDN0MsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO1lBQ2xCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsR0FBRyxTQUFTLEdBQUcsaUJBQWlCLENBQUMsQ0FBQzthQUM1RTtTQUNGO1FBQ0QsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksT0FBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDN0QsTUFBTSxJQUFJLEtBQUssQ0FBQywyQkFBMkIsR0FBRyxTQUFTLEdBQUcsNEJBQTRCLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3RHO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxpREFBaUQ7SUFDakQsSUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQzVDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUNyQixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7S0FDdEM7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7QUFFRjs7Ozs7Ozs7OztHQVVHO0FBQ0gsVUFBVSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsR0FBRyxVQUFTLE1BQTZDO0lBQTdDLHVCQUFBLEVBQUEsV0FBNkM7SUFDckcsSUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQztJQUNyQixJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtRQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7S0FDcEQ7SUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLGtCQUFrQixJQUFJLENBQUMsRUFBRSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRTtRQUMzRCxPQUFPLEVBQUUsQ0FBQztLQUNYO0lBRUQsSUFBSSxNQUFNLENBQUM7SUFDWCxnRkFBZ0Y7SUFDaEYsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO1FBQ2pCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO0tBQ3hCO1NBQU07UUFDTCxJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1NBQ3ZEO1FBQ0QsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNuRDtJQUVELElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQztJQUNsQixJQUFNLFVBQVUsR0FBRyxnQkFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsVUFBUyxJQUFJO1FBQ3pDLElBQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BELElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDO1lBQ3RDLEtBQUssRUFBRSxHQUFHO1lBQ1YsY0FBYyxFQUFFLElBQUksQ0FBQyxVQUFVO1NBQ2hDLENBQUMsQ0FBQztRQUNILElBQUk7WUFDRixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztnQkFDbkMsS0FBSyxFQUFFLElBQUksQ0FBQyxtQkFBbUI7Z0JBQy9CLFFBQVEsRUFBRSxNQUFNO2FBQ2pCLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQyw2Q0FBNkMsRUFBRSxJQUFJLENBQUMsYUFBYSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDM0c7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQyxDQUFDO0FBRUYsVUFBVSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEdBQUcsVUFBUyxNQUFNO0lBQ2xELE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO0lBQ3RCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ3pDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7SUFDN0QsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztJQUN6QixJQUFNLFNBQVMsR0FBMEIsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUMxRCxJQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDO0lBQ25DLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQ3hDLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztLQUNqRDtJQUNELElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQzFDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztLQUNsRDtJQUNELElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFO1FBQ3RCLFVBQVUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7S0FDbEQ7SUFFRCw2Q0FBNkM7SUFDN0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLElBQUksU0FBUyxDQUFDLFVBQVUsRUFBRTtRQUNwRCxVQUFVLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUM7S0FDaEQ7SUFFRCxxREFBcUQ7SUFDckQsSUFBSSxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLG9CQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ3JGLElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDWixPQUFPLEdBQUcsdUJBQWEsRUFBRSxDQUFDO0tBQzNCO0lBRUQsd0NBQXdDO0lBQ3hDLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQzVDLEtBQUssRUFBRSxPQUFPO1FBQ2QsY0FBYyxFQUFFLFNBQVMsQ0FBQyxNQUFNO0tBQ2pDLENBQUMsQ0FBQztJQUVILG1DQUFtQztJQUNuQyxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2xELElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDN0MsS0FBSyxFQUFFLGNBQWM7UUFDckIsUUFBUSxFQUFFLFlBQVk7S0FDdkIsQ0FBQyxDQUFDO0lBRUgsSUFBTSxNQUFNLEdBQUc7UUFDYixJQUFJLEVBQUUsSUFBSTtRQUNWLFdBQVcsRUFBRSxTQUFTLENBQUMsV0FBVztRQUNsQyxRQUFRLEVBQUUsU0FBUyxDQUFDLE1BQU07UUFDMUIsVUFBVSxFQUFFLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFDeEQsbUJBQW1CLEVBQUUsbUJBQW1CO1FBQ3hDLGVBQWUsRUFBRSxTQUFTO0tBQzNCLENBQUM7SUFFRixJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUU7UUFDMUIsTUFBTSxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDO0tBQ2pEO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxVQUFTLE1BQU0sRUFBRSxRQUFRO0lBQ25ELE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO0lBQ3RCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ3pDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLGlCQUFpQixDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFeEgsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1FBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztLQUN4QztJQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDdkUsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUNaLE1BQU0sRUFBRTtTQUNSLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNyQixDQUFDLENBQUM7QUFFRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFDSCxVQUFVLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBRyxVQUFTLE1BQU0sRUFBRSxRQUFRO0lBQ3ZELE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO0lBQ3RCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ3pDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFbEQsSUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztJQUN2QyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtRQUMzQixNQUFNLElBQUksS0FBSyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7S0FDL0Q7SUFFRCxJQUFNLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbEIsSUFBTSxhQUFhLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQztTQUNuQyxLQUFLLENBQUMsYUFBYSxDQUFDO1NBQ3BCLFNBQVMsQ0FBQyxVQUFTLFVBQVU7UUFDNUIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDN0MsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxFQUFFLENBQUM7SUFFVCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQy9DLElBQUksQ0FBQyxVQUFTLFVBQVU7UUFFdkIsd0JBQXdCO1FBQ3hCLElBQU0sY0FBYyxHQUFVLEVBQUUsQ0FBQztRQUNqQyx1REFBdUQ7UUFDdkQsSUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sSUFBSSx1QkFBYSxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFMUQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFTLFNBQVM7WUFDbkMsSUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQztZQUMxQyxJQUFNLElBQUksR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDeEMsSUFBSSxJQUFJLEVBQUU7Z0JBQ1IsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLE1BQU0sRUFBRTtvQkFDbkQsTUFBTSxJQUFJLEtBQUssQ0FBQyx3Q0FBd0MsR0FBRyxXQUFXLENBQUMsQ0FBQztpQkFDekU7Z0JBQ0QsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztvQkFDcEMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO29CQUNqQixTQUFTLEVBQUUsU0FBUztvQkFDcEIsVUFBVSxFQUFFLElBQUk7b0JBQ2hCLE9BQU8sRUFBRSxPQUFPO29CQUNoQixVQUFVLEVBQUUsSUFBSSxDQUFDLG9CQUFvQjtpQkFDdEMsQ0FBQyxDQUFDO2dCQUNILGNBQWMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDakM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQU0sTUFBTSxHQU1SO1lBQ0YsT0FBTyxFQUFFLGNBQWMsQ0FBQyxNQUFNO1lBQzlCLE9BQU8sRUFBRSxFQUFFO1NBQ1osQ0FBQztRQUVGLElBQU0sVUFBVSxHQUFHO1lBQ2pCLElBQU0sVUFBVSxHQUFHLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUMxQyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNmLE9BQU8sTUFBTSxDQUFDO2FBQ2Y7WUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO2lCQUMzQixJQUFJLENBQUMsVUFBUyxHQUFHO2dCQUNoQixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQyxPQUFPLFVBQVUsRUFBRSxDQUFDO1lBQ3RCLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsVUFBUyxHQUFHO2dCQUNqQixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUMvQyxPQUFPLFVBQVUsRUFBRSxDQUFDO1lBQ3RCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO1FBRUYsT0FBTyxVQUFVLEVBQUUsQ0FBQztJQUN0QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAaGlkZGVuXG4gKi9cblxuLyoqXG4gKi9cbi8vXG4vLyBUcmF2ZWxSdWxlIE9iamVjdFxuLy8gQml0R28gYWNjZXNzb3IgZm9yIGEgc3BlY2lmaWMgZW50ZXJwcmlzZVxuLy9cbi8vIENvcHlyaWdodCAyMDE0LCBCaXRHbywgSW5jLiAgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbi8vXG5cbmltcG9ydCAqIGFzIGJpdGNvaW4gZnJvbSAnYml0Z28tdXR4by1saWInO1xuaW1wb3J0ICogYXMgY29tbW9uIGZyb20gJy4vY29tbW9uJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldE5ldHdvcmssIG1ha2VSYW5kb21LZXksIGhkUGF0aCB9IGZyb20gJy4vYml0Y29pbic7XG5cbmludGVyZmFjZSBEZWNyeXB0UmVjZWl2ZWRUcmF2ZWxSdWxlT3B0aW9ucyB7XG4gIHR4Pzoge1xuICAgIHJlY2VpdmVkVHJhdmVsSW5mbz86IHtcbiAgICAgIHRvUHViS2V5UGF0aDogc3RyaW5nO1xuICAgICAgZnJvbVB1YktleTogc3RyaW5nO1xuICAgICAgZW5jcnlwdGVkVHJhdmVsSW5mbzogc3RyaW5nO1xuICAgICAgdHJhdmVsSW5mbzogc3RyaW5nO1xuICAgICAgdHJhbnNhY3Rpb25JZDogc3RyaW5nO1xuICAgICAgb3V0cHV0SW5kZXg6IG51bWJlcjtcbiAgICB9W107XG4gIH07XG4gIGtleWNoYWluPzoge1xuICAgIHhwcnY/OiBzdHJpbmc7XG4gIH07XG4gIGhkbm9kZT86IGJpdGNvaW4uSEROb2RlO1xufVxuXG5pbnRlcmZhY2UgUmVjaXBpZW50IHtcbiAgZW50ZXJwcmlzZTogc3RyaW5nO1xuICBwdWJLZXk6IHN0cmluZztcbiAgb3V0cHV0SW5kZXg6IHN0cmluZztcbn1cblxuLy9cbi8vIENvbnN0cnVjdG9yXG4vL1xuY29uc3QgVHJhdmVsUnVsZSA9IGZ1bmN0aW9uKGJpdGdvKSB7XG4gIHRoaXMuYml0Z28gPSBiaXRnbztcbn07XG5cblRyYXZlbFJ1bGUucHJvdG90eXBlLnVybCA9IGZ1bmN0aW9uKGV4dHJhKSB7XG4gIGV4dHJhID0gZXh0cmEgfHwgJyc7XG4gIHJldHVybiB0aGlzLmJpdGdvLnVybCgnL3RyYXZlbC8nICsgZXh0cmEpO1xufTtcblxuXG4vKipcbiAgKiBHZXQgYXZhaWxhYmxlIHRyYXZlbC1ydWxlIGluZm8gcmVjaXBpZW50cyBmb3IgYSB0cmFuc2FjdGlvblxuICAqIEBwYXJhbSBwYXJhbXNcbiAgKiAgdHhpZDogdHJhbnNhY3Rpb24gaWRcbiAgKiBAcGFyYW0gY2FsbGJhY2tcbiAgKiBAcmV0dXJucyB7Kn1cbiAgKi9cblRyYXZlbFJ1bGUucHJvdG90eXBlLmdldFJlY2lwaWVudHMgPSBmdW5jdGlvbihwYXJhbXMsIGNhbGxiYWNrKSB7XG4gIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgcGFyYW1zLnR4aWQgPSBwYXJhbXMudHhpZCB8fCBwYXJhbXMuaGFzaDtcbiAgY29tbW9uLnZhbGlkYXRlUGFyYW1zKHBhcmFtcywgWyd0eGlkJ10sIFtdLCBjYWxsYmFjayk7XG5cbiAgY29uc3QgdXJsID0gdGhpcy51cmwocGFyYW1zLnR4aWQgKyAnL3JlY2lwaWVudHMnKTtcbiAgcmV0dXJuIHRoaXMuYml0Z28uZ2V0KHVybClcbiAgLnJlc3VsdCgncmVjaXBpZW50cycpXG4gIC5ub2RlaWZ5KGNhbGxiYWNrKTtcbn07XG5cblRyYXZlbFJ1bGUucHJvdG90eXBlLnZhbGlkYXRlVHJhdmVsSW5mbyA9IGZ1bmN0aW9uKGluZm8pIHtcbiAgY29uc3QgZmllbGRzID0ge1xuICAgIGFtb3VudDogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgIHRvQWRkcmVzczogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIHRvRW50ZXJwcmlzZTogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIGZyb21Vc2VyTmFtZTogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIGZyb21Vc2VyQWNjb3VudDogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIGZyb21Vc2VyQWRkcmVzczogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIHRvVXNlck5hbWU6IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICB0b1VzZXJBY2NvdW50OiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgdG9Vc2VyQWRkcmVzczogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgIGV4dHJhOiB7IHR5cGU6ICdvYmplY3QnIH1cbiAgfTtcblxuICBfLmZvckVhY2goZmllbGRzLCBmdW5jdGlvbihmaWVsZDogYW55LCBmaWVsZE5hbWUpIHtcbiAgICAvLyBObyByZXF1aXJlZCBmaWVsZHMgeWV0IC0tIHNob3VsZCB0aGVyZSBiZT9cbiAgICBpZiAoZmllbGQucmVxdWlyZWQpIHtcbiAgICAgIGlmIChpbmZvW2ZpZWxkTmFtZV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgcmVxdWlyZWQgZmllbGQgJyArIGZpZWxkTmFtZSArICcgaW4gdHJhdmVsIGluZm8nKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGluZm9bZmllbGROYW1lXSAmJiB0eXBlb2YoaW5mb1tmaWVsZE5hbWVdKSAhPT0gZmllbGQudHlwZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbmNvcnJlY3QgdHlwZSBmb3IgZmllbGQgJyArIGZpZWxkTmFtZSArICcgaW4gdHJhdmVsIGluZm8sIGV4cGVjdGVkICcgKyBmaWVsZC50eXBlKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIFN0cmlwIG91dCBhbnkgb3RoZXIgZmllbGRzIHdlIGRvbid0IGtub3cgYWJvdXRcbiAgY29uc3QgcmVzdWx0ID0gXy5waWNrKGluZm8sIF8ua2V5cyhmaWVsZHMpKTtcbiAgaWYgKF8uaXNFbXB0eShyZXN1bHQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdlbXB0eSB0cmF2ZWwgZGF0YScpO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG4vKipcbiAqIFRha2VzIGEgdHJhbnNhY3Rpb24gb2JqZWN0IGFzIHJldHVybmVkIGJ5IGdldFRyYW5zYWN0aW9uIG9yIGxpc3RUcmFuc2FjdGlvbnMsIGFsb25nXG4gKiB3aXRoIGEga2V5Y2hhaW4gKG9yIGhkbm9kZSBvYmplY3QpLCBhbmQgYXR0ZW1wdHMgdG8gZGVjcnlwdCBhbnkgZW5jcnlwdGVkIHRyYXZlbFxuICogaW5mbyBpbmNsdWRlZCBpbiB0aGUgdHJhbnNhY3Rpb24ncyByZWNlaXZlZFRyYXZlbEluZm8gZmllbGQuXG4gKiBQYXJhbWV0ZXJzOlxuICogICB0eDogYSB0cmFuc2FjdGlvbiBvYmplY3RcbiAqICAga2V5Y2hhaW46IGtleWNoYWluIG9iamVjdCAod2l0aCB4cHJ2KVxuICogICBoZG5vZGU6IGEgYml0Y29pbi5IRE5vZGUgb2JqZWN0IChtYXkgYmUgcHJvdmlkZWQgaW5zdGVhZCBvZiBrZXljaGFpbilcbiAqIFJldHVybnM6XG4gKiAgIHRoZSB0eCBvYmplY3QsIGF1Z21lbnRlZCB3aXRoIGRlY3J5cHRlZCB0cmF2ZWxJbmZvIGZpZWxkc1xuICovXG5UcmF2ZWxSdWxlLnByb3RvdHlwZS5kZWNyeXB0UmVjZWl2ZWRUcmF2ZWxJbmZvID0gZnVuY3Rpb24ocGFyYW1zOiBEZWNyeXB0UmVjZWl2ZWRUcmF2ZWxSdWxlT3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHR4ID0gcGFyYW1zLnR4O1xuICBpZiAoIV8uaXNPYmplY3QodHgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdleHBlY3RpbmcgdHggcGFyYW0gdG8gYmUgb2JqZWN0Jyk7XG4gIH1cblxuICBpZiAoIXR4LnJlY2VpdmVkVHJhdmVsSW5mbyB8fCAhdHgucmVjZWl2ZWRUcmF2ZWxJbmZvLmxlbmd0aCkge1xuICAgIHJldHVybiB0eDtcbiAgfVxuXG4gIGxldCBoZE5vZGU7XG4gIC8vIFBhc3NpbmcgaW4gaGRub2RlIGlzIGZhc3RlciBiZWNhdXNlIGl0IGRvZXNuJ3QgcmVjb25zdHJ1Y3QgdGhlIGtleSBldmVyeSB0aW1lXG4gIGlmIChwYXJhbXMuaGRub2RlKSB7XG4gICAgaGROb2RlID0gcGFyYW1zLmhkbm9kZTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBrZXljaGFpbiA9IHBhcmFtcy5rZXljaGFpbjtcbiAgICBpZiAoIV8uaXNPYmplY3Qoa2V5Y2hhaW4pIHx8ICFfLmlzU3RyaW5nKGtleWNoYWluLnhwcnYpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2V4cGVjdGluZyBrZXljaGFpbiBwYXJhbSB3aXRoIHhwcnYnKTtcbiAgICB9XG4gICAgaGROb2RlID0gYml0Y29pbi5IRE5vZGUuZnJvbUJhc2U1OChrZXljaGFpbi54cHJ2KTtcbiAgfVxuXG4gIGNvbnN0IHNlbGYgPSB0aGlzO1xuICBjb25zdCBoZFBhdGhOb2RlID0gaGRQYXRoKGhkTm9kZSk7XG4gIHR4LnJlY2VpdmVkVHJhdmVsSW5mby5mb3JFYWNoKGZ1bmN0aW9uKGluZm8pIHtcbiAgICBjb25zdCBrZXkgPSBoZFBhdGhOb2RlLmRlcml2ZUtleShpbmZvLnRvUHViS2V5UGF0aCk7XG4gICAgY29uc3Qgc2VjcmV0ID0gc2VsZi5iaXRnby5nZXRFQ0RIU2VjcmV0KHtcbiAgICAgIGVja2V5OiBrZXksXG4gICAgICBvdGhlclB1YktleUhleDogaW5mby5mcm9tUHViS2V5XG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IHRoaXMuYml0Z28uZGVjcnlwdCh7XG4gICAgICAgIGlucHV0OiBpbmZvLmVuY3J5cHRlZFRyYXZlbEluZm8sXG4gICAgICAgIHBhc3N3b3JkOiBzZWNyZXRcbiAgICAgIH0pO1xuICAgICAgaW5mby50cmF2ZWxJbmZvID0gSlNPTi5wYXJzZShkZWNyeXB0ZWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcignZmFpbGVkIHRvIGRlY3J5cHQgb3IgcGFyc2UgdHJhdmVsIGluZm8gZm9yICcsIGluZm8udHJhbnNhY3Rpb25JZCArICc6JyArIGluZm8ub3V0cHV0SW5kZXgpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHR4O1xufTtcblxuVHJhdmVsUnVsZS5wcm90b3R5cGUucHJlcGFyZVBhcmFtcyA9IGZ1bmN0aW9uKHBhcmFtcykge1xuICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gIHBhcmFtcy50eGlkID0gcGFyYW1zLnR4aWQgfHwgcGFyYW1zLmhhc2g7XG4gIGNvbW1vbi52YWxpZGF0ZVBhcmFtcyhwYXJhbXMsIFsndHhpZCddLCBbJ2Zyb21Qcml2YXRlSW5mbyddKTtcbiAgY29uc3QgdHhpZCA9IHBhcmFtcy50eGlkO1xuICBjb25zdCByZWNpcGllbnQ6IFJlY2lwaWVudCB8IHVuZGVmaW5lZCA9IHBhcmFtcy5yZWNpcGllbnQ7XG4gIGxldCB0cmF2ZWxJbmZvID0gcGFyYW1zLnRyYXZlbEluZm87XG4gIGlmICghcmVjaXBpZW50IHx8ICFfLmlzT2JqZWN0KHJlY2lwaWVudCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgb3IgbWlzc2luZyByZWNpcGllbnQnKTtcbiAgfVxuICBpZiAoIXRyYXZlbEluZm8gfHwgIV8uaXNPYmplY3QodHJhdmVsSW5mbykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgb3IgbWlzc2luZyB0cmF2ZWxJbmZvJyk7XG4gIH1cbiAgaWYgKCFwYXJhbXMubm9WYWxpZGF0ZSkge1xuICAgIHRyYXZlbEluZm8gPSB0aGlzLnZhbGlkYXRlVHJhdmVsSW5mbyh0cmF2ZWxJbmZvKTtcbiAgfVxuXG4gIC8vIEZpbGwgaW4gdG9FbnRlcnByaXNlIGlmIG5vdCBhbHJlYWR5IGZpbGxlZFxuICBpZiAoIXRyYXZlbEluZm8udG9FbnRlcnByaXNlICYmIHJlY2lwaWVudC5lbnRlcnByaXNlKSB7XG4gICAgdHJhdmVsSW5mby50b0VudGVycHJpc2UgPSByZWNpcGllbnQuZW50ZXJwcmlzZTtcbiAgfVxuXG4gIC8vIElmIGEga2V5IHdhcyBub3QgcHJvdmlkZWQsIGNyZWF0ZSBhIG5ldyByYW5kb20ga2V5XG4gIGxldCBmcm9tS2V5ID0gcGFyYW1zLmZyb21LZXkgJiYgYml0Y29pbi5FQ1BhaXIuZnJvbVdJRihwYXJhbXMuZnJvbUtleSwgZ2V0TmV0d29yaygpKTtcbiAgaWYgKCFmcm9tS2V5KSB7XG4gICAgZnJvbUtleSA9IG1ha2VSYW5kb21LZXkoKTtcbiAgfVxuXG4gIC8vIENvbXB1dGUgdGhlIHNoYXJlZCBrZXkgZm9yIGVuY3J5cHRpb25cbiAgY29uc3Qgc2hhcmVkU2VjcmV0ID0gdGhpcy5iaXRnby5nZXRFQ0RIU2VjcmV0KHtcbiAgICBlY2tleTogZnJvbUtleSxcbiAgICBvdGhlclB1YktleUhleDogcmVjaXBpZW50LnB1YktleVxuICB9KTtcblxuICAvLyBKU09OLWlmeSBhbmQgZW5jcnlwdCB0aGUgcGF5bG9hZFxuICBjb25zdCB0cmF2ZWxJbmZvSlNPTiA9IEpTT04uc3RyaW5naWZ5KHRyYXZlbEluZm8pO1xuICBjb25zdCBlbmNyeXB0ZWRUcmF2ZWxJbmZvID0gdGhpcy5iaXRnby5lbmNyeXB0KHtcbiAgICBpbnB1dDogdHJhdmVsSW5mb0pTT04sXG4gICAgcGFzc3dvcmQ6IHNoYXJlZFNlY3JldFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSB7XG4gICAgdHhpZDogdHhpZCxcbiAgICBvdXRwdXRJbmRleDogcmVjaXBpZW50Lm91dHB1dEluZGV4LFxuICAgIHRvUHViS2V5OiByZWNpcGllbnQucHViS2V5LFxuICAgIGZyb21QdWJLZXk6IGZyb21LZXkuZ2V0UHVibGljS2V5QnVmZmVyKCkudG9TdHJpbmcoJ2hleCcpLFxuICAgIGVuY3J5cHRlZFRyYXZlbEluZm86IGVuY3J5cHRlZFRyYXZlbEluZm8sXG4gICAgZnJvbVByaXZhdGVJbmZvOiB1bmRlZmluZWRcbiAgfTtcblxuICBpZiAocGFyYW1zLmZyb21Qcml2YXRlSW5mbykge1xuICAgIHJlc3VsdC5mcm9tUHJpdmF0ZUluZm8gPSBwYXJhbXMuZnJvbVByaXZhdGVJbmZvO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbi8qKlxuICogU2VuZCB0cmF2ZWwgZGF0YSB0byB0aGUgc2VydmVyIGZvciBhIHRyYW5zYWN0aW9uXG4gKi9cblRyYXZlbFJ1bGUucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihwYXJhbXMsIGNhbGxiYWNrKSB7XG4gIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgcGFyYW1zLnR4aWQgPSBwYXJhbXMudHhpZCB8fCBwYXJhbXMuaGFzaDtcbiAgY29tbW9uLnZhbGlkYXRlUGFyYW1zKHBhcmFtcywgWyd0eGlkJywgJ3RvUHViS2V5JywgJ2VuY3J5cHRlZFRyYXZlbEluZm8nXSwgWydmcm9tUHViS2V5JywgJ2Zyb21Qcml2YXRlSW5mbyddLCBjYWxsYmFjayk7XG5cbiAgaWYgKCFfLmlzTnVtYmVyKHBhcmFtcy5vdXRwdXRJbmRleCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgb3V0cHV0SW5kZXgnKTtcbiAgfVxuXG4gIHJldHVybiB0aGlzLmJpdGdvLnBvc3QodGhpcy51cmwocGFyYW1zLnR4aWQgKyAnLycgKyBwYXJhbXMub3V0cHV0SW5kZXgpKVxuICAuc2VuZChwYXJhbXMpXG4gIC5yZXN1bHQoKVxuICAubm9kZWlmeShjYWxsYmFjayk7XG59O1xuXG4vKipcbiAqIFNlbmQgbXVsdGlwbGUgdHJhdmVsIHJ1bGUgaW5mb3MgZm9yIHRoZSBvdXRwdXRzIG9mIGEgc2luZ2xlIHRyYW5zYWN0aW9uLlxuICogUGFyYW1ldGVyczpcbiAqICAgLSB0eGlkIChvciBoYXNoKTogdHhpZCBvZiB0aGUgdHJhbnNhY3Rpb24gKG11c3QgYmUgYSBzZW5kZXIgb2YgdGhlIHR4KVxuICogICAtIHRyYXZlbEluZm9zOiBhcnJheSBvZiB0cmF2ZWxJbmZvIG9iamVjdHMgd2hpY2ggbG9vayBsaWtlIHRoZSBmb2xsb3dpbmc6XG4gKiAgICAge1xuICogICAgICAgb3V0cHV0SW5kZXg6IG51bWJlciwgICAgIC8vIHR4IG91dHB1dCBpbmRleFxuICogICAgICAgZnJvbVVzZXJOYW1lOiBzdHJpbmcsICAgIC8vIG5hbWUgb2YgdGhlIHNlbmRpbmcgdXNlclxuICogICAgICAgZnJvbVVzZXJBY2NvdW50OiBzdHJpbmcsIC8vIGFjY291bnQgaWQgb2YgdGhlIHNlbmRpbmcgdXNlclxuICogICAgICAgZnJvbVVzZXJBZGRyZXNzOiBzdHJpbmcsIC8vIG1haWxpbmcgYWRkcmVzcyBvZiB0aGUgc2VuZGluZyB1c2VyXG4gKiAgICAgICB0b1VzZXJOYW1lOiBzdHJpbmcsICAgICAgLy8gbmFtZSBvZiB0aGUgcmVjZWl2aW5nIHVzZXJcbiAqICAgICAgIHRvVXNlckFjY291bnQ6IHN0cmluZywgICAvLyBhY2NvdW50IGlkIG9mIHRoZSByZWNlaXZpbmcgdXNlclxuICogICAgICAgdG9Vc2VyQWRkcmVzczogc3RyaW5nICAgIC8vIG1haWxpbmcgYWRkcmVzcyBvZiB0aGUgcmVjZWl2aW5nIHVzZXJcbiAqICAgICB9XG4gKiAgICAgQWxsIGZpZWxkcyBhc2lkZSBmcm9tIG91dHB1dEluZGV4IGFyZSBvcHRpb25hbCwgYnV0IGF0IGxlYXN0IG9uZSBtdXN0XG4gKiAgICAgYmUgZGVmaW5lZC5cbiAqXG4gKiAgSXQgaXMgbm90IG5lY2Vzc2FyeSB0byBwcm92aWRlIHRyYXZlbEluZm8gZm9yIGFsbCBvdXRwdXQgaW5kaWNlcy5cbiAqICBFbmQtdG8tZW5kIGVuY3J5cHRpb24gb2YgdGhlIHRyYXZlbCBpbmZvIGlzIGhhbmRsZWQgYXV0b21hdGljYWxseSBieSB0aGlzIG1ldGhvZC5cbiAqXG4gKi9cblRyYXZlbFJ1bGUucHJvdG90eXBlLnNlbmRNYW55ID0gZnVuY3Rpb24ocGFyYW1zLCBjYWxsYmFjaykge1xuICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gIHBhcmFtcy50eGlkID0gcGFyYW1zLnR4aWQgfHwgcGFyYW1zLmhhc2g7XG4gIGNvbW1vbi52YWxpZGF0ZVBhcmFtcyhwYXJhbXMsIFsndHhpZCddLCBjYWxsYmFjayk7XG5cbiAgY29uc3QgdHJhdmVsSW5mb3MgPSBwYXJhbXMudHJhdmVsSW5mb3M7XG4gIGlmICghXy5pc0FycmF5KHRyYXZlbEluZm9zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignZXhwZWN0ZWQgcGFyYW1ldGVyIHRyYXZlbEluZm9zIHRvIGJlIGFycmF5Jyk7XG4gIH1cblxuICBjb25zdCBzZWxmID0gdGhpcztcbiAgY29uc3QgdHJhdmVsSW5mb01hcCA9IF8odHJhdmVsSW5mb3MpXG4gIC5rZXlCeSgnb3V0cHV0SW5kZXgnKVxuICAubWFwVmFsdWVzKGZ1bmN0aW9uKHRyYXZlbEluZm8pIHtcbiAgICByZXR1cm4gc2VsZi52YWxpZGF0ZVRyYXZlbEluZm8odHJhdmVsSW5mbyk7XG4gIH0pXG4gIC52YWx1ZSgpO1xuXG4gIHJldHVybiBzZWxmLmdldFJlY2lwaWVudHMoeyB0eGlkOiBwYXJhbXMudHhpZCB9KVxuICAudGhlbihmdW5jdGlvbihyZWNpcGllbnRzKSB7XG5cbiAgICAvLyBCdWlsZCB1cCBkYXRhIHRvIHBvc3RcbiAgICBjb25zdCBzZW5kUGFyYW1zTGlzdDogYW55W10gPSBbXTtcbiAgICAvLyBkb24ndCByZWdlbmVyYXRlIGEgbmV3IHJhbmRvbSBrZXkgZm9yIGVhY2ggcmVjaXBpZW50XG4gICAgY29uc3QgZnJvbUtleSA9IHBhcmFtcy5mcm9tS2V5IHx8IG1ha2VSYW5kb21LZXkoKS50b1dJRigpO1xuXG4gICAgcmVjaXBpZW50cy5mb3JFYWNoKGZ1bmN0aW9uKHJlY2lwaWVudCkge1xuICAgICAgY29uc3Qgb3V0cHV0SW5kZXggPSByZWNpcGllbnQub3V0cHV0SW5kZXg7XG4gICAgICBjb25zdCBpbmZvID0gdHJhdmVsSW5mb01hcFtvdXRwdXRJbmRleF07XG4gICAgICBpZiAoaW5mbykge1xuICAgICAgICBpZiAoaW5mby5hbW91bnQgJiYgaW5mby5hbW91bnQgIT09IHJlY2lwaWVudC5hbW91bnQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Ftb3VudCBkaWQgbm90IG1hdGNoIGZvciBvdXRwdXQgaW5kZXggJyArIG91dHB1dEluZGV4KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzZW5kUGFyYW1zID0gc2VsZi5wcmVwYXJlUGFyYW1zKHtcbiAgICAgICAgICB0eGlkOiBwYXJhbXMudHhpZCxcbiAgICAgICAgICByZWNpcGllbnQ6IHJlY2lwaWVudCxcbiAgICAgICAgICB0cmF2ZWxJbmZvOiBpbmZvLFxuICAgICAgICAgIGZyb21LZXk6IGZyb21LZXksXG4gICAgICAgICAgbm9WYWxpZGF0ZTogdHJ1ZSAvLyBkb24ndCByZS12YWxpZGF0ZVxuICAgICAgICB9KTtcbiAgICAgICAgc2VuZFBhcmFtc0xpc3QucHVzaChzZW5kUGFyYW1zKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdDoge1xuICAgICAgbWF0Y2hlZDogbnVtYmVyO1xuICAgICAgcmVzdWx0czoge1xuICAgICAgICByZXN1bHQ/OiBhbnk7XG4gICAgICAgIGVycm9yPzogc3RyaW5nO1xuICAgICAgfVtdO1xuICAgIH0gPSB7XG4gICAgICBtYXRjaGVkOiBzZW5kUGFyYW1zTGlzdC5sZW5ndGgsXG4gICAgICByZXN1bHRzOiBbXVxuICAgIH07XG5cbiAgICBjb25zdCBzZW5kU2VyaWFsID0gZnVuY3Rpb24oKSB7XG4gICAgICBjb25zdCBzZW5kUGFyYW1zID0gc2VuZFBhcmFtc0xpc3Quc2hpZnQoKTtcbiAgICAgIGlmICghc2VuZFBhcmFtcykge1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHNlbGYuc2VuZChzZW5kUGFyYW1zKVxuICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgIHJlc3VsdC5yZXN1bHRzLnB1c2goeyByZXN1bHQ6IHJlcyB9KTtcbiAgICAgICAgcmV0dXJuIHNlbmRTZXJpYWwoKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIHJlc3VsdC5yZXN1bHRzLnB1c2goeyBlcnJvcjogZXJyLnRvU3RyaW5nKCkgfSk7XG4gICAgICAgIHJldHVybiBzZW5kU2VyaWFsKCk7XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlbmRTZXJpYWwoKTtcbiAgfSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFRyYXZlbFJ1bGU7XG4iXX0=